<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impostor Fútbol</title>
<!-- Incluye las fuentes y íconos necesarios -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bebas+Neue&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
:root {
--color-primary: #004d98; /* Azul profundo como la camiseta */
--color-secondary: #00bfff; /* Celeste */
--color-accent: #fcd116; /* Dorado */
--color-text-dark: #222;
--color-text-light: #fff;
--color-bg: #e0f7fa;
--color-success: #28a745;
--color-danger: #dc3545;
--font-main: 'Bebas Neue', 'Inter', sans-serif;
--font-secondary: 'Inter', 'Roboto', sans-serif;
}

body {
font-family: var(--font-secondary);
background: linear-gradient(135deg, var(--color-bg), #b3e5fc);
color: var(--color-text-dark);
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
margin: 0;
padding: 20px;
box-sizing: border-box;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z" fill="%23004d98"/><circle cx="50" cy="50" r="40" fill="%23fcd116" stroke="%2300bfff" stroke-width="5" fill-opacity="0.2"/></svg>');
background-size: 50px;
background-repeat: repeat;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
transition: background 0.5s;
}

body.impostor-alarm {
background: radial-gradient(circle at center, #f00 0%, #800 100%) !important;
animation: subtleAlarm 5s infinite alternate;
}
@keyframes subtleAlarm {
  0% { opacity: 1; }
  100% { opacity: 0.8; }
}

.container {
background: rgba(255, 255, 255, 0.95);
padding: 30px;
border-radius: 20px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
text-align: center;
max-width: 500px;
width: 100%;
border: 5px solid var(--color-primary);
position: relative;
overflow: hidden;
transition: transform 0.3s ease-out;
}

h1 {
font-family: var(--font-main);
font-size: clamp(2rem, 8vw, 4rem);
color: var(--color-primary);
text-shadow: 3px 3px 0 var(--color-secondary), 6px 6px 0 var(--color-accent);
letter-spacing: 2px;
margin-bottom: 20px;
text-transform: uppercase;
}

h2 {
font-family: var(--font-main);
font-size: clamp(1.5rem, 6vw, 3rem);
color: var(--color-text-dark);
margin-bottom: 20px;
}

.screen {
display: none;
flex-direction: column;
align-items: center;
justify-content: flex-start;
gap: 20px;
padding: 10px;
border: 2px solid var(--color-primary);
border-radius: 15px;
background: #fff;
box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
opacity: 0;
transform: translateY(20px);
max-height: 80vh;
overflow-y: auto;
}

.screen::-webkit-scrollbar { width: 8px; }
.screen::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
.screen::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
.screen::-webkit-scrollbar-thumb:hover { background: #aaa; }


.screen.active {
display: flex;
opacity: 1;
transform: translateY(0);
}

.btn {
font-family: var(--font-main);
font-size: clamp(1.2rem, 5vw, 2rem);
padding: 15px 30px;
border: none;
border-radius: 10px;
cursor: pointer;
text-transform: uppercase;
letter-spacing: 1px;
transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
width: 100%;
max-width: 300px;
color: var(--color-text-light);
background: var(--color-primary);
background-image: linear-gradient(to right, var(--color-primary) 0%, #0060c0 100%);
border: 2px solid var(--color-text-light);
}

.btn:hover:not(:disabled) {
transform: translateY(-3px);
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
background-image: linear-gradient(to right, #0060c0 0%, var(--color-primary) 100%);
}

.btn:disabled {
background: #999;
cursor: not-allowed;
transform: none;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
background-image: none;
opacity: 0.6;
}


.btn.secondary {
background: var(--color-secondary);
background-image: linear-gradient(to right, var(--color-secondary) 0%, #33c8ff 100%);
margin-top: 10px;
border: 2px solid var(--color-primary);
}
.small-btn {
font-size: 1rem;
max-width: 250px;
padding: 10px 20px;
margin: 15px auto 0 auto;
}

.option-group {
width: 100%;
padding: 15px 0;
border-bottom: 1px dashed #ccc;
}

.count-controls {
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
margin-bottom: 10px;
}

.option-label {
font-family: var(--font-secondary);
font-size: 1.2rem;
font-weight: 700;
color: var(--color-text-dark);
}

.option-value {
font-family: var(--font-main);
font-size: 2.5rem;
color: var(--color-primary);
}

.arrow-btn {
background: transparent;
border: none;
cursor: pointer;
color: var(--color-primary);
font-size: 2rem;
transition: transform 0.2s, color 0.2s;
}

.arrow-btn:hover {
transform: scale(1.2);
color: var(--color-accent);
}

/* Estilos para inputs */
.input-field {
width: 100%;
padding: 10px;
border: 2px solid var(--color-secondary);
border-radius: 8px;
font-size: 1rem;
text-align: center;
transition: border-color 0.2s;
box-sizing: border-box;
max-width: 300px;
}

.input-field:focus {
outline: none;
border-color: var(--color-primary);
}

/* Estilos para el selector de categoría */
#category-selector {
width: 100%;
padding: 10px;
border: 2px solid var(--color-primary);
border-radius: 8px;
font-size: 1.1rem;
background-color: #f8f8f8;
font-family: var(--font-secondary);
cursor: pointer;
max-width: 300px;
}

/* Estilos para grupo de checkboxes */
.checkbox-group {
display: flex;
flex-direction: column;
align-items: flex-start;
gap: 15px;
padding: 10px 20px;
text-align: left;
width: 100%;
box-sizing: border-box;
max-width: 300px;
margin: 0 auto;
}
.checkbox-group div {
display: flex;
align-items: center;
gap: 10px;
}
.checkbox-group label {
font-family: var(--font-secondary);
font-size: 1.1rem;
font-weight: 500;
color: var(--color-text-dark);
}
.checkbox-group input[type="checkbox"] {
width: 20px;
height: 20px;
cursor: pointer;
}


/* Pantalla de juego */
.game-display {
background-color: #f0f0f0;
border: 4px solid var(--color-primary);
border-radius: 15px;
padding: 40px 20px;
min-height: 200px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
width: 100%;
box-sizing: border-box;
box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
}
#player-name-display {
font-family: var(--font-main);
font-size: clamp(2rem, 8vw, 4rem);
color: var(--color-primary);
animation: fadeIn 0.5s ease-out;
}

#word-display {
font-family: var(--font-main);
font-size: clamp(1.8rem, 7vw, 3.5rem);
color: var(--color-text-dark);
text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
text-transform: uppercase;
text-align: center;
animation: zoomIn 0.3s ease-out;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

.hidden { display: none; }

.impostor-text {
color: var(--color-accent);
animation: pulse 1.5s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}

/* Status de Conexión */
#connection-status {
font-family: var(--font-secondary);
font-size: 0.9rem;
margin-top: 15px;
padding: 5px 10px;
border-radius: 5px;
font-weight: bold;
}
.status-loading { background-color: #ffc107; color: #333; }
.status-connected { background-color: var(--color-success); color: var(--color-text-light); }
.status-failed { background-color: var(--color-danger); color: var(--color-text-light); }

/* Sala Online */
#online-room-id-display, #online-user-id {
font-size: 1rem;
font-weight: bold;
color: var(--color-primary);
margin-top: 5px;
word-break: break-all;
}
#online-user-id-wrapper {
font-size: 0.8rem;
color: #666;
margin-bottom: 10px;
}
.room-member {
padding: 5px;
border-bottom: 1px dotted #ccc;
display: flex;
justify-content: space-between;
align-items: center;
}
.room-member:last-child { border-bottom: none; }
.member-name { font-weight: bold; }
.host-badge { background-color: var(--color-accent); color: var(--color-text-dark); padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; }

/* Modal */
.modal {
display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
}
.modal-content {
background-color: #fefefe; padding: 20px; border-radius: 10px; text-align: center;
max-width: 400px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;
}
@keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Estilos de la pantalla final */
#impostor-reveal-btn {
margin-top: 15px;
background-color: #d9534f;
background-image: linear-gradient(to right, #d9534f 0%, #c9302c 100%);
}

#impostor-list {
list-style: none;
padding: 0;
font-family: var(--font-secondary);
font-size: 1.4rem;
font-weight: bold;
color: #c9302c; /* Rojo para los impostores */
margin-top: 10px;
}
#end-message-final {
font-size: 1.2rem;
color: var(--color-text-dark);
}
#special-round-info {
font-size: 1.3rem;
font-weight: bold;
color: var(--color-primary);
margin-top: 10px;
}
</style>
</head>
<body>

<div class="container">
<!-- Pantalla de inicio -->
<div id="start-screen" class="screen active">
<h1>Impostor Fútbol</h1>
<p>Descubre el impostor entre tus amigos. ¡Que comience el partido!</p>
<div id="connection-status" class="status-loading">Conectando...</div>
<button id="start-game-btn" class="btn">Iniciar Partida Local</button>
<button id="online-game-btn" class="btn secondary" disabled>Sala Online</button>
</div>

<!-- Pantalla de configuración (Local) -->
<div id="config-screen-local" class="screen">
<h2>Configuración Local</h2>
<!-- Controles de jugadores y opciones de juego -->
<div class="option-group">
<div class="count-controls">
<button class="arrow-btn" id="players-minus" aria-label="Disminuir jugadores"><i class="fas fa-arrow-left"></i></button>
<div>
<div class="option-label">Jugadores</div>
<div class="option-value" id="player-count-display">3</div>
</div>
<button class="arrow-btn" id="players-plus" aria-label="Aumentar jugadores"><i class="fas fa-arrow-right"></i></button>
</div>
<button id="toggle-names-btn" class="btn secondary small-btn">Cambiar nombres de jugadores</button>
<div id="player-names-container" class="hidden"></div>
</div>
<div class="option-group">
<div class="count-controls">
<button class="arrow-btn" id="impostors-minus" aria-label="Disminuir impostores"><i class="fas fa-arrow-left"></i></button>
<div>
<div class="option-label">Impostores</div>
<div class="option-value" id="impostor-count-display">1</div>
</div>
<button class="arrow-btn" id="impostors-plus" aria-label="Aumentar impostores"><i class="fas fa-arrow-right"></i></button>
</div>
</div>
<div class="option-group">
<div class="option-label">Tema de la Palabra</div>
<select id="category-selector-local">
<option value="players">Jugadores de Fútbol</option>
<option value="clubs">Clubes de Fútbol</option>
<option value="clashroyale">Cartas de Clash Royale</option>
<option value="f1Pilots">Pilotos de F1</option>
<option value="alumnos3ro">Alumnos 3ro</option>
<option value="genteColegio">Gente del Colegio</option>
<option value="profes">Profesores</option>
<option value="cosasCotidianas">Cosas Cotidianas</option>
<option value="random">Al Azar</option>
</select>
</div>
<div class="option-group checkbox-group">
<div><input type="checkbox" id="special-rounds-check-local"><label for="special-rounds-check-local">Habilitar Rondas Especiales</label></div>
<div><input type="checkbox" id="impostor-knows-check-local" checked><label for="impostor-knows-check-local">El impostor sabe que es impostor</label></div>
</div>
<button id="start-round-btn-local" class="btn">Iniciar Partida</button>
<button id="back-to-start-btn-local" class="btn secondary small-btn">Volver</button>
</div>

<!-- Pantalla de Sala Online -->
<div id="online-screen" class="screen">
<h2>Sala Online</h2>
<p id="online-user-id-wrapper">Mi ID de Usuario: <span id="online-user-id">Cargando...</span></p>

<!-- Opciones de Sala -->
<div class="option-group">
<input type="text" id="room-name-input" class="input-field" placeholder="Nombre de tu sala (e.g., Campeones)">
<button id="create-room-btn" class="btn">Crear Sala</button>
</div>

<div class="option-group">
<input type="text" id="join-room-id-input" class="input-field" placeholder="ID de Sala a Unirse">
<button id="join-room-btn" class="btn secondary">Unirse a Sala</button>
</div>

<button id="back-to-start-btn-online" class="btn secondary small-btn">Volver</button>
</div>

<!-- Pantalla de Espera de Sala (Online/Host) -->
<div id="lobby-screen" class="screen">
<h2 id="lobby-title">Sala: </h2>
<p id="lobby-room-id-display">ID de Sala: <span id="online-room-id-display"></span></p>

<!-- Lista de Miembros -->
<div class="option-group" style="max-width: 350px; width: 100%;">
<div class="option-label" style="border-bottom: 2px solid var(--color-primary);">Miembros de la Sala</div>
<div id="room-members-list" style="max-height: 200px; overflow-y: auto;">
<!-- Miembros se cargarán aquí -->
</div>
</div>

<!-- Opciones de Host/Comunes -->
<div id="host-options">
<h3>Opciones de Partida</h3>
<div class="option-group">
<div class="option-label">Impostores</div>
<div class="count-controls">
<button class="arrow-btn" id="impostors-minus-online"><i class="fas fa-arrow-left"></i></button>
<div class="option-value" id="impostor-count-display-online">1</div>
<button class="arrow-btn" id="impostors-plus-online"><i class="fas fa-arrow-right"></i></button>
</div>
</div>
<div class="option-group">
<div class="option-label">Tema</div>
<select id="category-selector-online" class="input-field">
<option value="players">Jugadores de Fútbol</option>
<!-- Otras opciones de categoría aquí -->
</select>
</div>
<button id="start-online-game-btn" class="btn">Iniciar Juego Online</button>
</div>

<!-- Opción de jugador normal -->
<p id="wait-message" style="color: var(--color-primary); font-weight: bold; margin-top: 15px;" class="hidden">Esperando que el Host inicie la partida...</p>

<button id="leave-room-btn" class="btn secondary small-btn">Abandonar Sala</button>
</div>

<!-- Pantalla de juego (mostrar palabra) - Compartida con Local -->
<div id="word-screen" class="screen">
<h2 id="player-name-display">Es el turno de...</h2>
<div class="game-display">
<button id="show-word-btn" class="btn">Mostrar Palabra</button>
<p id="word-display" class="hidden"></p>
</div>
<button id="next-player-btn" class="btn secondary">Siguiente Jugador</button>
</div>

<!-- Pantalla final -->
<div id="end-screen" class="screen">
<h2>¡Final de la Ronda!</h2>
<p id="end-message-initial">Ahora es momento de discutir y votar. ¿Quién te pareció el más sospechoso?</p>
<button id="impostor-reveal-btn" class="btn">Revelar Impostores</button>
<div id="reveal-area" class="hidden">
<p id="special-round-info" class="hidden"></p>
<p id="end-message-final">Los impostores eran:</p>
<ul id="impostor-list"></ul>
</div>

<button id="play-again-btn" class="btn">Jugar de Nuevo</button>
<button id="change-settings-btn" class="btn secondary">Cambiar Ajustes</button>
</div>

</div>
<!-- Modal para mensajes de error o información -->
<div id="message-modal" class="modal">
<div class="modal-content">
<p id="modal-text"></p>
<button id="modal-close-btn" class="btn">Entendido</button>
</div>
</div>

<script type="module">
import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- BASE DE DATOS DE PALABRAS (Mantenida localmente) ---
const playersList = [
"Lionel Messi", "Cristiano Ronaldo", "Diego Maradona", "Pelé", "Zinedine Zidane",
"Ronaldo Nazário", "Johan Cruyff", "Franz Beckenbauer", "Denzel Dumfries",
"Alfredo Di Stéfano", "Marco van Basten", "Andrés Iniesta", "Xavi Hernández", "Ronaldinho Gaúcho",
"Neymar Jr.", "Kylian Mbappé", "Erling Haaland", "Luka Modrić", "Kevin De Bruyne", 
"Mohamed Salah", "Robert Lewandowski", "Sergio Ramos", "Virgil van Dijk", "Manuel Neuer",
"Alisson Becker", "Marc-André ter Stegen", "Paulo Dybala", "Ángel Di María", "Lautaro Martínez",
"Julián Álvarez", "Frank Fabra", "N'Golo Kanté", "Sadio Mané", "Harry Kane", 
"Son Heung-min", "Thierry Henry", "Didier Drogba", "Samuel Eto'o", "Arjen Robben", 
"Franck Ribéry", "Carles Puyol", "Gerard Piqué", "Andrea Pirlo", "Gianluigi Buffon", 
"Iker Casillas", "David Beckham", "Kaká", "Wayne Rooney", "Frank Lampard",
"Steven Gerrard", "Paolo Maldini", "Roberto Baggio", "Gabriel Batistuta", "Federico Chiesa",
"Javier Zanetti", "Gonzalo Montiel", "Juan Román Riquelme", "Carlos Tévez", "Sergio Agüero",
"Diego Simeone", "Alan Velasco", "Mascherano", "Javier Saviola", "Pablo Aimar",
"Radamel Falcao", "James Rodríguez", "Luis Suárez", "Edinson Cavani", "Arturo Vidal",
"Alexis Sánchez", "Christian Pulisic", "Rodrigo De Paul", "Chicharito Hernández",
"Guillermo Ochoa", "Francesco Totti", "Alessandro Del Piero", "Giorgio Chiellini",
"Leonardo Bonucci", "Nahuel Molina", "Mario Balotelli", "Paul Pogba", "Antoine Griezmann",
"Karim Benzema", "Vinícius Jr.", "Rodrygo", "Federico Valverde", "Casemiro",
"Toni Kroos", "Thomas Müller", "Joshua Kimmich", "Manuel Neuer", "Mesut Özil",
"Marco Reus", "Leroy Sané", "Kai Havertz", "Timo Werner", "Jude Bellingham", 
"Phil Foden", "Jack Grealish", "Marcus Rashford", "Bukayo Saka", "Mason Mount",
"Declan Rice", "Trent Alexander-Arnold", "Kyle Walker", "Raheem Sterling", "Hakim Ziyech",
"Achraf Hakimi", "Riyad Mahrez", "André Onana", "Christian Eriksen", "Pierre-Emerick Aubameyang",
"Heung-Min Son", "Miguel Merentiel", "Ivan Rakitić", "Josko Gvardiol", "Gareth Bale",
"Bruno Fernandes", "Bernardo Silva", "João Félix", "Rúben Dias", "Raphael Varane",
"Raphael Guerreiro", "João Cancelo", "Gonçalo Ramos", "Vitinha", "Darwin Núñez",
"Luis Díaz", "Luis Muriel", "Juan Guillermo Cuadrado", "David Ospina", "David Neres",
"Antony", "Fred", "Gabriel Martinelli", "Gabriel Jesus", "Vini Jr",
"Sergio Busquets", "Jordi Alba", "Ferran Torres", "Gavi", "Pedri",
"Emiliano Martínez", "Alejandro Garnacho", "Nico Otamendi", "Ponzio", "Ortega"
];
const clubsList = [
"Real Madrid", "FC Barcelona", "Manchester United", "Liverpool FC", "Bayern Múnich",
"Juventus FC", "AC Milán", "Inter de Milán", "París Saint-Germain", "Manchester City",
"Chelsea FC", "Arsenal FC", "Atlético de Madrid", "Borussia Dortmund", "Ajax Ámsterdam",
"River Plate", "Boca Juniors", "Independiente", "Racing Club", "San Lorenzo",
"São Paulo FC", "CR Flamengo", "SE Palmeiras", "Club América", "Chivas Guadalajara",
"Inter Miami", "New York City FC", "Benfica", "FC Porto", "Sporting CP",
"Olympique de Lyon", "Olympique de Marsella", "AS Mónaco", "Galatasaray SK", "Fenerbahçe SK",
"Besiktas JK", "Celtic FC", "Rangers FC", "Napoli", "AS Roma",
"Valencia CF", "Sevilla FC", "Real Betis", "Tottenham Hotspur", "Leicester City",
"West Ham United", "Everton FC", "Bayer Leverkusen", "RB Leipzig", "Schalke 04"
];
const clashRoyaleList = [
"Gigante Eléctrico", "Montapuercos", "P.E.K.K.A", "Mago Eléctrico", "Mini P.E.K.K.A",
"Príncipe", "Princesa", "Caballero", "Valquiria", "Bruja",
"Bebé Dragón", "Esqueleto Gigante", "Golem", "Sabueso de Lava", "Dragón Infernal",
"Cementerio", "Tronco", "Bola de Fuego", "Rayo", "Cohete",
"Descarga", "Flechas", "Veneno", "Tornado", "Emperatriz Espiritual",
"Pandilla de Duendes", "Esqueletos", "Murciélagos", "Espíritu de Hielo", "Espíritu de Fuego",
"Arqueras", "Mosquetera", "Duendes con Lanza", "Duendes", "Mega Esbirro",
"Trío de Mosqueteras", "Bárbaros de Élite", "Mago de Hielo", "Leñador", "Bandida",
"Furia", "Clon", "Espejo", "Recolector de Elixir", "Torre Infierno",
"Ballesta", "Mortero", "Horno", "Jaula del Forzudo", "Ariete de Batalla",
"Barril de Duendes", "Barril de Esqueletos", "Globo", "Minero", "Puerco Gigante",
"Curandera Guerrera", "Torre Tesla", "Choza de Bárbaros", "Torre Bombardera", "Rey Esqueleto"
];
const f1PilotsList = [
"Max Verstappen", "Lewis Hamilton", "Charles Leclerc", "Lando Norris", "Fernando Alonso",
"Sergio Pérez", "George Russell", "Carlos Sainz", "Oscar Piastri", "Daniel Ricciardo",
"Sebastian Vettel", "Michael Schumacher", "Ayrton Senna", "Alain Prost", "Niki Lauda",
"Franco Colapinto", "Juan Manuel Fangio", "Kimi Räikkönen", "Jenson Button", "Nico Rosberg",
"Valtteri Bottas", "Esteban Ocon", "Pierre Gasly", "Yuki Tsunoda", "Lance Stroll",
"Alexander Albon", "Kevin Magnussen", "Nico Hülkenberg", "Zhou Guanyu", "Logan Sargeant", "Jack Doohan"
];
const alumnos3roList = [
"Bauti", "Beltina", "Bernardita", "Guada Molina", "Simon Carranza", "Emma Llugdar", 
"Emma Carabajal", "Fabri", "Felipon", "Fran", "Gae", "Guada Elias", "Jana", "Jazmin", 
"Jere", "Juana", "Lara", "Lola", "Lolo", "Lucia", "Masao", "Mateo", "Matias", 
"Santi Hiller", "Nika", "Julia", "Olivia", "Pedro", "Santino", "Simon Abbadie", 
"Sofia", "Thiago Michiels", "Valentina", "Victoria"
];
const genteColegioList = [
"Bauti", "Beltina", "Bernardita", "Guada Molina", "Simon Carranza", "Emma Llugdar", 
"Emma Carabajal", "Fabri", "Felipon", "Fran", "Gae", "Guada Elias", "Jana", "Jazmin", 
"Jere", "Juana", "Lara", "Lola", "Lolo", "Lucia", "Masao", "Mateo", "Matias", 
"Santi Hiller", "Nika", "Julia", "Olivia", "Pedro", "Santino", "Simon Abbadie", 
"Sofia", "Thiago Michiels", "Valentina", "Victoria", "La suplente de PDL", 
"Diana Justel (Profe de Ingles)", "Mara Camba (Profe de Ingles)", "Cintia Milano (Profe de Plastica)", 
"Vicky Lasarte (Profe de Matematica)", "Julieta Levis (Profe de Matematica)", 
"Debora Alvarez (Profe de Matematica)", "Cyntia de La Vega (Profe de Matematica)", 
"Francisco Santillan (Profe de Historia)", "Angie Diz (Profe de PDL)", 
"Mariana Fernandez (Profe de Biologia)", "Estefania Maffei (Profe de Biologia)", 
"Marcelo (Profe de Primaria Turno Mañana)", "Eugenia Huinchulef (Profe de Construccion de Ciudadania)", 
"Cintia Olsen (Profe de Taller)", "Carmen (Profe de Teatro y Ciudadania)", 
"Rocio Maldini (Profe de Fisico-Quimica)", "Quesadilla", "Gero (Hermano de Ramiro Ali)", 
"Jano (1ro)", "Uma (Hermana de Jana)", "Tizi (Hermana de Lolo)", "Ramiro", "Felipe Sanchez", 
"Joaco Lopez", "Thiago Barcala", "Simon Contartese", "Juanse", "Ezequiel", "Luisiana", 
"Milo", "Manuel Saucedo", "Julia Franchini", "Alma (Bolivar)", "Lucas (Preceptor)", 
"Giuli (Preceptora)", "Noe (Preceptora)", "Isis (Preceptora)", "Agucho (Recepción)"
];
const profesList = [
"La suplente de PDL", "Diana Justel (Profe de Ingles)", "Mara Camba (Profe de Ingles)", 
"Cintia Milano (Profe de Plastica)", "Vicky Lasarte (Profe de Matematica)", 
"Julieta Levis (Profe de Matematica)", "Debora Alvarez (Profe de Matematica)", 
"Cyntia de La Vega (Profe de Matematica)", "Francisco Santillan (Profe de Historia)", 
"Angie Diz (Profe de PDL)", "Mariana Fernandez (Profe de Biologia)", 
"Estefania Maffei (Profe de Biologia)", "Marcelo (Profe de Primaria Turno Mañana)", 
"Eugenia Huinchulef (Profe de Construccion de Ciudadania)", "Cintia Olsen (Profe de Taller)", 
"Carmen (Profe de Teatro y Ciudadania)", "Rocio Maldini (Profe de Fisico-Quimica)", 
"Tic (Profe de Tecnologia)", "Lucia di Gregori (Profe de Ingles 1ro)", "Pedro (Suplente Matematica)"
];
const cosasCotidianasList = [
"Lápiz", "Goma de borrar", "Cuaderno", "Pizarrón", "Tiza", "Marcador", "Mochila", 
"Cartuchera", "Silla", "Mesa", "Computadora", "Celular", "Llaves", "Vaso", "Plato", 
"Tenedor", "Cuchillo", "Cuchara", "Botella de agua", "Zapatillas", "Remera", "Pantalón", 
"Reloj", "Anteojos", "Cama", "Almohada", "Puerta", "Ventana", "Foco", "Lámpara", 
"Libro", "Sofá", "Televisor", "Auto", "Bicicleta", "Colectivo", "Semáforo", "Árbol", 
"Pasto", "Nube", "Sol", "Luna", "Cepillo de dientes", "Ducha", "Jabón", "Shampoo"
];
const allWordLists = {
    players: playersList,
    clubs: clubsList,
    clashroyale: clashRoyaleList,
    f1Pilots: f1PilotsList,
    alumnos3ro: alumnos3roList,
    genteColegio: genteColegioList,
    profes: profesList,
    cosasCotidianas: cosasCotidianasList,
    random: [...playersList, ...clubsList, ...clashRoyaleList, ...f1PilotsList, ...alumnos3roList, ...genteColegioList, ...profesList, ...cosasCotidianasList]
};
const categoryNames = {
    players: "Jugadores de Fútbol",
    clubs: "Clubes de Fútbol",
    clashroyale: "Cartas de Clash Royale",
    f1Pilots: "Pilotos de F1",
    alumnos3ro: "Alumnos 3ro",
    genteColegio: "Gente del Colegio",
    profes: "Profesores",
    cosasCotidianas: "Cosas Cotidianas",
    random: "Al Azar"
}

// --- FIREBASE GLOBALES ---
let app, db, auth;
let currentUserId = null;
let currentAppId = null;
let isFirebaseConnected = false;
let roomUnsubscribe = null; // Listener para la sala

// --- VARIABLES DE ESTADO LOCAL/ONLINE ---
let gameMode = 'local'; // 'local' o 'online'
let currentRoomId = null;
let isHost = false;
let localPlayerName = `Invitado-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;

// LOCAL GAME STATE
let playerCount = 3;
let impostorCount = 1;
let playerNames = ["Jugador 1", "Jugador 2", "Jugador 3"]; 
let selectedCategoryLocal = "players";
let enableSpecialRoundsLocal = false;
let impostorKnowsLocal = true;

// SHARED GAME STATE (Local/Online)
let impostorIndices = [];
let wordForPlayers = "";
let wordForImpostor = "";
let currentPlayerIndex = 0;
let currentRoundType = "normal";


// --- REFERENCIAS DEL DOM ---
const startScreen = document.getElementById('start-screen');
const configScreenLocal = document.getElementById('config-screen-local');
const onlineScreen = document.getElementById('online-screen');
const lobbyScreen = document.getElementById('lobby-screen');
const wordScreen = document.getElementById('word-screen');
const endScreen = document.getElementById('end-screen');

const startGameBtn = document.getElementById('start-game-btn');
const onlineGameBtn = document.getElementById('online-game-btn');
const connectionStatusEl = document.getElementById('connection-status');
const onlineUserIdEl = document.getElementById('online-user-id');
const roomNameInput = document.getElementById('room-name-input');
const createRoomBtn = document.getElementById('create-room-btn');
const joinRoomIdInput = document.getElementById('join-room-id-input');
const joinRoomBtn = document.getElementById('join-room-btn');
const backToStartBtnLocal = document.getElementById('back-to-start-btn-local');
const backToStartBtnOnline = document.getElementById('back-to-start-btn-online');
const leaveRoomBtn = document.getElementById('leave-room-btn');

// Lobby elements
const lobbyTitleEl = document.getElementById('lobby-title');
const onlineRoomIdDisplayEl = document.getElementById('online-room-id-display');
const roomMembersListEl = document.getElementById('room-members-list');
const hostOptionsEl = document.getElementById('host-options');
const waitMessageEl = document.getElementById('wait-message');
const impostorCountOnlineEl = document.getElementById('impostor-count-display-online');
const impostorsMinusOnlineBtn = document.getElementById('impostors-minus-online');
const impostorsPlusOnlineBtn = document.getElementById('impostors-plus-online');
const categorySelectorOnline = document.getElementById('category-selector-online');
const startOnlineGameBtn = document.getElementById('start-online-game-btn');

// Game elements (shared)
const playerNameDisplayEl = document.getElementById('player-name-display');
const wordDisplayEl = document.getElementById('word-display');
const showWordBtn = document.getElementById('show-word-btn');
const nextPlayerBtn = document.getElementById('next-player-btn');

// Final screen (shared)
const impostorRevealBtn = document.getElementById('impostor-reveal-btn');
const revealArea = document.getElementById('reveal-area');
const specialRoundInfoEl = document.getElementById('special-round-info');
const endMessageInitialEl = document.getElementById('end-message-initial');
const endMessageFinal = document.getElementById('end-message-final');
const impostorListEl = document.getElementById('impostor-list');
const playAgainBtn = document.getElementById('play-again-btn');
const changeSettingsBtn = document.getElementById('change-settings-btn');

// Local config elements
const playerCountEl = document.getElementById('player-count-display');
const impostorCountEl = document.getElementById('impostor-count-display');
const playerNamesContainer = document.getElementById('player-names-container');
const categorySelectorLocal = document.getElementById('category-selector-local');
const specialRoundsCheckLocal = document.getElementById('special-rounds-check-local');
const impostorKnowsCheckLocal = document.getElementById('impostor-knows-check-local');
const startRoundBtnLocal = document.getElementById('start-round-btn-local');

// Modal elements
const modalText = document.getElementById('modal-text');
const modalCloseBtn = document.getElementById('modal-close-btn');

// --- FIREBASE INICIALIZACIÓN ---

function getRoomRef(roomId) {
    // Las salas son públicas para que cualquier usuario pueda unirse
    const roomPath = `/artifacts/${currentAppId}/public/data/rooms/${roomId}`;
    return doc(db, roomPath);
}

function initFirebase() {
    setLogLevel('debug'); // Habilitar logs para depuración

    // 1. Obtener ID de App y Configuración de Firebase
    currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : 'null';
    
    let firebaseConfig = null;
    try {
        firebaseConfig = JSON.parse(firebaseConfigString);
        if (!firebaseConfig.apiKey) throw new Error("API Key missing from config.");
    } catch (e) {
        console.warn("Error al parsear __firebase_config o faltan credenciales:", e);
        connectionStatusEl.textContent = "Conexión Fallida (Solo Modo Local)";
        connectionStatusEl.classList.add('status-failed');
        onlineGameBtn.disabled = true;
        isFirebaseConnected = false;
        return; // Detener si la configuración es inválida
    }

    // 2. Inicializar App y Servicios
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);

    // 3. Listener de Autenticación
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            onlineUserIdEl.textContent = currentUserId;
            
            connectionStatusEl.textContent = "Modo Online Activo";
            connectionStatusEl.classList.remove('status-loading', 'status-failed');
            connectionStatusEl.classList.add('status-connected');
            onlineGameBtn.disabled = false;
            isFirebaseConnected = true;

        } else {
            // Intentar iniciar sesión
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Falló:", error);
                connectionStatusEl.textContent = "Conexión Fallida (Solo Modo Local)";
                connectionStatusEl.classList.add('status-failed');
                onlineGameBtn.disabled = true;
                isFirebaseConnected = false;
            }
        }
    });
}

// --- FUNCIONES DE INTERFAZ Y UTILIDAD ---

function showMessage(message) {
    modalText.textContent = message;
    messageModal.style.display = 'flex';
}
modalCloseBtn.addEventListener('click', () => {
    messageModal.style.display = 'none';
});

function showScreen(screen) {
    document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active');
    });
    screen.classList.add('active');
}

function stopAlarm() {
    document.body.classList.remove('impostor-alarm');
}

function generateRandomRoomId() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function getWordList(category) {
    if (category === 'random') {
        const categories = Object.keys(allWordLists).filter(c => c !== 'random');
        const randomCategory = categories[Math.floor(Math.random() * categories.length)];
        return allWordLists[randomCategory];
    }
    return allWordLists[category] || allWordLists.players;
}

// --- LÓGICA DE JUEGO MULTIJUGADOR (ONLINE) ---

async function createRoom(roomName) {
    if (!currentUserId) return showMessage("Error: Usuario no autenticado.");
    if (!isFirebaseConnected) return showMessage("Error: Firebase no está conectado.");

    const roomId = generateRandomRoomId();
    const roomRef = getRoomRef(roomId);
    
    // Obtener un nombre base para el jugador
    const baseName = roomNameInput.value.trim() || localPlayerName;
    const roomTitle = roomName.trim() || `Sala de ${baseName}`;

    const newRoomData = {
        title: roomTitle,
        hostId: currentUserId,
        status: 'lobby', // 'lobby', 'in_game', 'finished'
        impostorCount: 1,
        category: 'players',
        currentPlayerIndex: 0,
        wordForPlayers: "",
        wordForImpostor: "",
        impostorIndices: [],
        currentRoundType: 'normal',
        players: [{
            id: currentUserId,
            name: baseName,
            isHost: true
        }],
        lastUpdated: Date.now()
    };

    try {
        await setDoc(roomRef, newRoomData);
        currentRoomId = roomId;
        isHost = true;
        gameMode = 'online';
        startRoomListener(roomId);
        showScreen(lobbyScreen);
    } catch (e) {
        console.error("Error al crear sala:", e);
        showMessage("No se pudo crear la sala. Inténtalo de nuevo.");
    }
}

async function joinRoom(roomId) {
    if (!currentUserId) return showMessage("Error: Usuario no autenticado.");
    if (!isFirebaseConnected) return showMessage("Error: Firebase no está conectado.");
    
    const roomRef = getRoomRef(roomId);
    
    // Usar una transacción para asegurar que no se une a una sala inexistente o llena
    try {
        await runTransaction(db, async (transaction) => {
            const roomDoc = await transaction.get(roomRef);
            if (!roomDoc.exists()) {
                throw new Error("La sala no existe.");
            }
            const roomData = roomDoc.data();
            
            if (roomData.status !== 'lobby') {
                throw new Error("La partida ya ha comenzado.");
            }
            
            const existingPlayer = roomData.players.find(p => p.id === currentUserId);
            if (!existingPlayer) {
                // Agregar al nuevo jugador
                const newPlayer = {
                    id: currentUserId,
                    name: localPlayerName,
                    isHost: false
                };
                transaction.update(roomRef, {
                    players: arrayUnion(newPlayer),
                    lastUpdated: Date.now()
                });
            }
            
            currentRoomId = roomId;
            isHost = false;
            gameMode = 'online';
        });
        
        startRoomListener(roomId);
        showScreen(lobbyScreen);
        
    } catch (e) {
        console.error("Error al unirse a la sala:", e);
        showMessage(e.message || "No se pudo unir a la sala. Verifica el ID.");
    }
}

function startRoomListener(roomId) {
    if (roomUnsubscribe) roomUnsubscribe();
    
    roomUnsubscribe = onSnapshot(getRoomRef(roomId), (doc) => {
        if (doc.exists()) {
            const room = doc.data();
            
            // Actualizar el estado global
            impostorCount = room.impostorCount;
            currentPlayerIndex = room.currentPlayerIndex;
            wordForPlayers = room.wordForPlayers;
            wordForImpostor = room.wordForImpostor;
            impostorIndices = room.impostorIndices;
            currentRoundType = room.currentRoundType;
            
            renderLobby(room);
            
            // Si el juego está en curso, ir a la pantalla de la palabra
            if (room.status === 'in_game') {
                if (currentPlayerIndex < room.players.length) {
                    gameMode = 'online';
                    updateWordScreenUI(room.players.map(p => p.name));
                    showScreen(wordScreen);
                } else {
                    // Juego finalizado/votación
                    showScreen(endScreen);
                }
            } else if (room.status === 'finished') {
                showScreen(endScreen);
            }
            
        } else {
            // La sala ha sido eliminada o ya no existe
            if (currentRoomId === roomId) {
                currentRoomId = null;
                isHost = false;
                gameMode = 'local';
                showScreen(startScreen);
                showMessage("La sala ha sido cerrada por el Host.");
            }
        }
    }, (error) => {
        console.error("Error en el listener de sala:", error);
        showMessage("Error de conexión con la sala. Volviendo al inicio.");
        leaveRoom();
    });
}

async function leaveRoom() {
    if (!currentRoomId || !currentUserId) return;
    
    if (roomUnsubscribe) {
        roomUnsubscribe();
        roomUnsubscribe = null;
    }
    
    const roomRef = getRoomRef(currentRoomId);
    
    try {
        if (isHost) {
            // Si eres el host, borra la sala
            await deleteDoc(roomRef);
        } else {
            // Si eres un jugador, sal de la lista de players
            await updateDoc(roomRef, {
                players: arrayRemove({
                    id: currentUserId,
                    name: localPlayerName, // Usamos el nombre local para el arrayRemove
                    isHost: false
                }),
                lastUpdated: Date.now()
            });
        }
    } catch (e) {
        console.warn("Error al salir/borrar sala:", e);
        // Continuar volviendo a la pantalla de inicio incluso si falla la limpieza
    }
    
    currentRoomId = null;
    isHost = false;
    gameMode = 'local';
    showScreen(startScreen);
}

// --- RENDERIZADO DEL LOBBY ---

function renderLobby(room) {
    lobbyTitleEl.textContent = room.title;
    onlineRoomIdDisplayEl.textContent = currentRoomId;
    
    // Host Options
    if (isHost) {
        hostOptionsEl.classList.remove('hidden');
        waitMessageEl.classList.add('hidden');
        
        // Sincronizar UI de Host con datos de la sala
        impostorCountOnlineEl.textContent = room.impostorCount;
        categorySelectorOnline.value = room.category;
        
        // Actualizar límites del host
        impostorsMinusOnlineBtn.disabled = room.impostorCount <= 1;
        impostorsPlusOnlineBtn.disabled = room.impostorCount >= room.players.length - 1 || room.players.length < 3;
        startOnlineGameBtn.disabled = room.players.length < 3;
        startOnlineGameBtn.textContent = room.players.length < 3 ? "Esperando jugadores (Mín. 3)" : "Iniciar Juego Online";

    } else {
        hostOptionsEl.classList.add('hidden');
        waitMessageEl.classList.remove('hidden');
    }
    
    // Lista de Miembros (Común)
    roomMembersListEl.innerHTML = '';
    room.players.forEach(player => {
        const div = document.createElement('div');
        div.classList.add('room-member');
        
        const nameSpan = document.createElement('span');
        nameSpan.classList.add('member-name');
        nameSpan.textContent = player.name;
        
        const infoDiv = document.createElement('div');
        if (player.isHost) {
            const hostBadge = document.createElement('span');
            hostBadge.classList.add('host-badge');
            hostBadge.textContent = 'Host';
            infoDiv.appendChild(hostBadge);
        }
        if (player.id === currentUserId) {
            nameSpan.textContent += ' (Tú)';
        }
        
        div.appendChild(nameSpan);
        div.appendChild(infoDiv);
        roomMembersListEl.appendChild(div);
    });
}

// --- LÓGICA DE JUEGO (COMPARTIDA) ---

async function setupGame(playerList, category, impostorCount) {
    impostorIndices = [];
    wordForPlayers = "";
    wordForImpostor = "";
    currentRoundType = "normal";
    currentPlayerIndex = 0;
    
    const playerCount = playerList.length;
    const wordList = getWordList(category);

    // 1. Elegir palabras (siempre de la lista real, incluso en el modo random)
    const playerWordIndex = Math.floor(Math.random() * wordList.length);
    wordForPlayers = wordList[playerWordIndex];
    
    // El impostor siempre sabe que es impostor en modo online por simplicidad
    wordForImpostor = "IMPOSTOR";

    // 2. Elegir Impostores
    const availablePlayerIndices = Array.from({length: playerCount}, (_, i) => i);
    let count = impostorCount;
    while (count > 0 && availablePlayerIndices.length > 0) {
        const impostorIndex = availablePlayerIndices.splice(Math.floor(Math.random() * availablePlayerIndices.length), 1)[0];
        impostorIndices.push(impostorIndex);
        count--;
    }
    
    // Si es online, actualizar Firestore. Si es local, las variables ya están actualizadas.
    if (gameMode === 'online' && isHost) {
        const roomRef = getRoomRef(currentRoomId);
        await updateDoc(roomRef, {
            status: 'in_game',
            currentPlayerIndex: 0,
            wordForPlayers: wordForPlayers,
            wordForImpostor: wordForImpostor,
            impostorIndices: impostorIndices,
            currentRoundType: 'normal', // Las rondas especiales se ignoran en modo online por simplicidad
            lastUpdated: Date.now()
        });
    }
}


// --- LÓGICA DE JUEGO LOCAL ---

function setupGameLocal() {
    currentPlayerIndex = 0;
    impostorIndices = [];
    wordForPlayers = "";
    wordForImpostor = "";
    currentRoundType = "normal";
    stopAlarm();
    
    // 1. Elegir la lista de palabras
    let wordList = getWordList(selectedCategoryLocal);

    // 2. Verificar Rondas Especiales (solo Local)
    if (enableSpecialRoundsLocal && Math.random() < 0.25) {
        const specialType = Math.floor(Math.random() * 4);
        
        switch (specialType) {
            case 0:
                currentRoundType = "Todos Impostores";
                impostorIndices = Array.from({length: playerCount}, (_, i) => i);
                wordForImpostor = "IMPOSTOR";
                wordForPlayers = "IMPOSTOR";
                break;
            case 1:
                currentRoundType = "Nadie es Impostor";
                impostorIndices = [];
                wordForPlayers = wordList[Math.floor(Math.random() * wordList.length)];
                break;
            case 2:
                currentRoundType = "Todos menos uno Impostor";
                const luckyPlayer = Math.floor(Math.random() * playerCount);
                impostorIndices = Array.from({length: playerCount}, (_, i) => i).filter(i => i !== luckyPlayer);
                wordForPlayers = wordList[Math.floor(Math.random() * wordList.length)];
                wordForImpostor = "IMPOSTOR";
                break;
            case 3:
            default:
                currentRoundType = "Todos con palabra distinta";
                impostorIndices = [];
                break;
        }
    } else {
        // 3. Lógica de Ronda Normal
        currentRoundType = "normal";
        
        const playerWordIndex = Math.floor(Math.random() * wordList.length);
        wordForPlayers = wordList[playerWordIndex];

        if (!impostorKnowsLocal) {
            let impostorWordIndex = Math.floor(Math.random() * wordList.length);
            while (impostorWordIndex === playerWordIndex) {
                impostorWordIndex = Math.floor(Math.random() * wordList.length);
            }
            wordForImpostor = wordList[impostorWordIndex];
        } else {
            wordForImpostor = "IMPOSTOR";
        }

        const availablePlayerIndices = Array.from({length: playerCount}, (_, i) => i);
        let count = impostorCount;
        while (count > 0 && availablePlayerIndices.length > 0) {
            const impostorIndex = availablePlayerIndices.splice(Math.floor(Math.random() * availablePlayerIndices.length), 1)[0];
            impostorIndices.push(impostorIndex);
            count--;
        }
    }
}

// --- ACTUALIZACIÓN DE UI EN JUEGO (COMPARTIDA) ---

function getPlayerNames() {
    if (gameMode === 'local') {
        return playerNames;
    } else if (currentRoomId) {
        // En modo online, la lista de jugadores viene del snapshot de la sala
        if (roomUnsubscribe && roomUnsubscribe.doc && roomUnsubscribe.doc.data().players) {
            return roomUnsubscribe.doc.data().players.map(p => p.name);
        }
        return [];
    }
    return playerNames; // Fallback
}


function updateWordScreenUI() {
    const names = getPlayerNames();
    const currentPlayerName = names[currentPlayerIndex] || `Jugador ${currentPlayerIndex + 1}`;
    
    playerNameDisplayEl.textContent = `Es el turno de ${currentPlayerName}`;
    wordDisplayEl.textContent = "";
    wordDisplayEl.classList.add('hidden');
    showWordBtn.classList.remove('hidden');

    if (currentPlayerIndex === names.length - 1) {
        nextPlayerBtn.textContent = "Finalizar Ronda";
    } else {
        nextPlayerBtn.textContent = "Siguiente Jugador";
    }
}

// --- EVENT LISTENERS ---

// Eventos de Navegación
startGameBtn.addEventListener('click', () => {
    gameMode = 'local';
    showScreen(configScreenLocal);
    renderPlayerNameInputs();
});
onlineGameBtn.addEventListener('click', () => {
    if (isFirebaseConnected) {
        showScreen(onlineScreen);
    } else {
        showMessage("El modo online no está disponible. Revisa la conexión.");
    }
});
backToStartBtnLocal.addEventListener('click', () => showScreen(startScreen));
backToStartBtnOnline.addEventListener('click', () => showScreen(startScreen));

// Eventos Online (Sala)
createRoomBtn.addEventListener('click', () => {
    const roomName = roomNameInput.value.trim();
    createRoom(roomName);
});

joinRoomBtn.addEventListener('click', () => {
    const roomId = joinRoomIdInput.value.trim().toUpperCase();
    if (roomId.length !== 6) {
        return showMessage("El ID de sala debe tener 6 caracteres.");
    }
    joinRoom(roomId);
});

leaveRoomBtn.addEventListener('click', leaveRoom);

// Eventos Online (Host Options)
impostorsMinusOnlineBtn.addEventListener('click', async () => {
    if (!isHost || !currentRoomId || impostorCount <= 1) return;
    try {
        await updateDoc(getRoomRef(currentRoomId), { impostorCount: impostorCount - 1 });
    } catch (e) { console.error("Error al actualizar impostores:", e); }
});
impostorsPlusOnlineBtn.addEventListener('click', async () => {
    const names = getPlayerNames();
    if (!isHost || !currentRoomId || impostorCount >= names.length - 1) return;
    try {
        await updateDoc(getRoomRef(currentRoomId), { impostorCount: impostorCount + 1 });
    } catch (e) { console.error("Error al actualizar impostores:", e); }
});
categorySelectorOnline.addEventListener('change', async (e) => {
    if (!isHost || !currentRoomId) return;
    try {
        await updateDoc(getRoomRef(currentRoomId), { category: e.target.value });
    } catch (e) { console.error("Error al actualizar categoría:", e); }
});
startOnlineGameBtn.addEventListener('click', async () => {
    if (!isHost || !currentRoomId) return;
    const roomData = roomUnsubscribe.doc.data();
    if (roomData.players.length < 3) {
        return showMessage("Necesitas al menos 3 jugadores para iniciar.");
    }
    const names = roomData.players.map(p => p.name);
    await setupGame(names, roomData.category, roomData.impostorCount);
});


// Eventos de Config Local (Reutilizados del código anterior)
function renderPlayerNameInputs() {
    // ... (Mantener la lógica de renderPlayerNameInputs igual que antes)
    playerNamesContainer.innerHTML = '';
    while (playerNames.length < playerCount) {
        playerNames.push(`Jugador ${playerNames.length + 1}`);
    }
    playerNames = playerNames.slice(0, playerCount);

    for (let i = 0; i < playerCount; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.classList.add('input-field');
        input.placeholder = `Jugador ${i + 1}`;
        input.value = playerNames[i];
        input.dataset.index = i;
        input.addEventListener('input', (e) => {
            playerNames[i] = e.target.value.trim() || `Jugador ${i + 1}`;
        });
        playerNamesContainer.appendChild(input);
    }
    playerCountEl.textContent = playerCount;
    updateImpostorLimitsLocal();
}

function updateImpostorLimitsLocal() {
    if (impostorCount >= playerCount) {
        impostorCount = playerCount - 1;
    }
    if (playerCount > 1 && impostorCount < 1) {
        impostorCount = 1;
    }
    impostorCountEl.textContent = impostorCount;
}

document.getElementById('toggle-names-btn').addEventListener('click', () => {
    playerNamesContainer.classList.toggle('hidden');
    const isHidden = playerNamesContainer.classList.contains('hidden');
    document.getElementById('toggle-names-btn').textContent = isHidden ? "Cambiar nombres de jugadores" : "Ocultar nombres";
});
document.getElementById('players-minus').addEventListener('click', () => {
    if (playerCount > 3) { playerCount--; renderPlayerNameInputs(); } else { showMessage("La cantidad mínima de jugadores es 3."); }
});
document.getElementById('players-plus').addEventListener('click', () => {
    if (playerCount < 34) { playerCount++; renderPlayerNameInputs(); } else { showMessage("Límite de 34 jugadores alcanzado."); }
});
document.getElementById('impostors-minus').addEventListener('click', () => {
    if (impostorCount > 1) { impostorCount--; updateImpostorLimitsLocal(); } else { showMessage("La cantidad mínima de impostores es 1."); }
});
document.getElementById('impostors-plus').addEventListener('click', () => {
    if (impostorCount < playerCount - 1) { impostorCount++; updateImpostorLimitsLocal(); } else { showMessage(`No puede haber ${playerCount} o más impostores.`); }
});

startRoundBtnLocal.addEventListener('click', () => {
    // Leer config local
    impostorCount = parseInt(impostorCountEl.textContent);
    selectedCategoryLocal = categorySelectorLocal.value;
    enableSpecialRoundsLocal = specialRoundsCheckLocal.checked;
    impostorKnowsLocal = impostorKnowsCheckLocal.checked;
    
    if (playerCount <= impostorCount) {
        return showMessage("La cantidad de jugadores debe ser mayor que la de impostores.");
    }
    document.querySelectorAll('#player-names-container .input-field').forEach((input, index) => {
        playerNames[index] = input.value.trim() || `Jugador ${index + 1}`;
    });

    gameMode = 'local';
    setupGameLocal();
    updateWordScreenUI();
    showScreen(wordScreen);
});


// Eventos de Juego (Compartidos)
showWordBtn.addEventListener('click', () => {
    const isImpostor = impostorIndices.includes(currentPlayerIndex);
    wordDisplayEl.classList.remove('impostor-text');
    stopAlarm();

    // Lógica para mostrar la palabra
    let wordToShow = "";
    if (currentRoundType === "Todos con palabra distinta") {
        let wordList = getWordList(gameMode === 'local' ? selectedCategoryLocal : categorySelectorOnline.value);
        wordToShow = wordList[Math.floor(Math.random() * wordList.length)];
    } else if (isImpostor) {
        wordToShow = wordForImpostor;
        wordDisplayEl.classList.add('impostor-text');
        // Simulación de alarma visual
        document.body.classList.add('impostor-alarm');
    } else {
        wordToShow = wordForPlayers;
    }

    wordDisplayEl.textContent = wordToShow;
    wordDisplayEl.classList.remove('hidden');
    showWordBtn.classList.add('hidden');
});

nextPlayerBtn.addEventListener('click', async () => {
    stopAlarm();
    const names = getPlayerNames();
    
    if (currentPlayerIndex < names.length - 1) {
        currentPlayerIndex++;
        
        if (gameMode === 'online' && isHost) {
            await updateDoc(getRoomRef(currentRoomId), { currentPlayerIndex: currentPlayerIndex, lastUpdated: Date.now() });
        }
        updateWordScreenUI();
    } else {
        // Fin de la ronda
        if (gameMode === 'online' && isHost) {
            await updateDoc(getRoomRef(currentRoomId), { status: 'finished', lastUpdated: Date.now() });
        }
        
        // La UI se actualiza con los datos finales de la ronda
        endMessageInitialEl.classList.remove('hidden');
        impostorRevealBtn.classList.remove('hidden');
        revealArea.classList.add('hidden');
        showScreen(endScreen);
    }
});

// Pantalla Final
impostorRevealBtn.addEventListener('click', () => {
    stopAlarm();
    impostorRevealBtn.classList.add('hidden');
    endMessageInitialEl.classList.add('hidden');
    revealArea.classList.remove('hidden');
    impostorListEl.innerHTML = '';
    
    const names = getPlayerNames();

    if (currentRoundType !== "normal") {
        specialRoundInfoEl.textContent = `¡Ronda Especial: ${currentRoundType}!`;
        specialRoundInfoEl.classList.remove('hidden');
    } else {
        specialRoundInfoEl.classList.add('hidden');
    }

    if (impostorIndices.length > 0) {
        endMessageFinal.textContent = "Los impostores eran:";
        impostorIndices.forEach(index => {
            const li = document.createElement('li');
            li.textContent = names[index] || `Jugador ${index + 1}`;
            impostorListEl.appendChild(li);
        });
    } else {
        endMessageFinal.textContent = "¡Nadie fue el impostor esta ronda!";
    }
});

playAgainBtn.addEventListener('click', () => {
    if (gameMode === 'local') {
        setupGameLocal();
        updateWordScreenUI();
        showScreen(wordScreen);
    } else if (gameMode === 'online' && isHost) {
        // En online, el host vuelve al lobby para reconfigurar o iniciar de nuevo.
        updateDoc(getRoomRef(currentRoomId), { status: 'lobby', currentPlayerIndex: 0, lastUpdated: Date.now() });
        showScreen(lobbyScreen);
    } else {
        // Jugador normal vuelve al lobby
        showScreen(lobbyScreen);
    }
});

changeSettingsBtn.addEventListener('click', () => {
    if (gameMode === 'local') {
        renderPlayerNameInputs();
        showScreen(configScreenLocal);
    } else if (gameMode === 'online') {
        if (isHost) {
            // Host puede cambiar la configuración del juego en el lobby
            updateDoc(getRoomRef(currentRoomId), { status: 'lobby', currentPlayerIndex: 0, lastUpdated: Date.now() });
        }
        showScreen(lobbyScreen);
    }
});


// --- INICIALIZACIÓN ---
document.addEventListener('DOMContentLoaded', () => {
    // Llenar selector de categorías para online y local
    const fillCategorySelector = (selector) => {
        selector.innerHTML = '';
        Object.entries(categoryNames).forEach(([key, value]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value;
            selector.appendChild(option);
        });
    };
    fillCategorySelector(categorySelectorLocal);
    fillCategorySelector(categorySelectorOnline);
    
    // Asignar el nombre local al azar
    localPlayerName = prompt("Ingresa tu nombre para el modo Online:") || localPlayerName;
    
    // Iniciar Firebase y el listener de Auth
    initFirebase();
    showScreen(startScreen);
});

</script>
</body>
</html>