<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impostor Fútbol</title>
<!-- Incluye las fuentes y íconos necesarios -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bebas+Neue&family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<!-- Se eliminó el script de Tone.js y toda la lógica de sonido -->

<style>
:root {
--color-primary: #004d98; /* Azul profundo como la camiseta */
--color-secondary: #00bfff; /* Celeste */
--color-accent: #fcd116; /* Dorado */
--color-text-dark: #222;
--color-text-light: #fff;
--color-bg: #e0f7fa;
--font-main: 'Bebas Neue', 'Inter', sans-serif;
--font-secondary: 'Inter', 'Roboto', sans-serif;
}

body {
font-family: var(--font-secondary);
background: linear-gradient(135deg, var(--color-bg), #b3e5fc);
color: var(--color-text-dark);
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
margin: 0;
padding: 20px;
box-sizing: border-box;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><path d="M50 0 L100 25 L100 75 L50 100 L0 75 L0 25 Z" fill="%23004d98"/><circle cx="50" cy="50" r="40" fill="%23fcd116" stroke="%2300bfff" stroke-width="5" fill-opacity="0.2"/></svg>');
background-size: 50px;
background-repeat: repeat;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
transition: background 0.5s;
}

/* NUEVO: Estilo para la alarma del impostor */
body.impostor-alarm {
background: #800 !important; /* Rojo oscuro */
}

.container {
background: rgba(255, 255, 255, 0.95);
padding: 30px;
border-radius: 20px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
text-align: center;
max-width: 500px;
width: 100%;
border: 5px solid var(--color-primary);
position: relative;
overflow: hidden;
transition: transform 0.3s ease-out;
}

h1 {
font-family: var(--font-main);
font-size: clamp(2rem, 8vw, 4rem);
color: var(--color-primary);
text-shadow: 3px 3px 0 var(--color-secondary), 6px 6px 0 var(--color-accent);
letter-spacing: 2px;
margin-bottom: 20px;
text-transform: uppercase;
}

h2 {
font-family: var(--font-main);
font-size: clamp(1.5rem, 6vw, 3rem);
color: var(--color-text-dark);
margin-bottom: 20px;
}

.screen {
display: none;
flex-direction: column;
align-items: center;
justify-content: flex-start;
gap: 20px;
padding: 10px;
border: 2px solid var(--color-primary);
border-radius: 15px;
background: #fff;
box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
opacity: 0;
transform: translateY(20px);
max-height: 80vh;
overflow-y: auto;
}

/* CSS para que el scroll sea más discreto */
.screen::-webkit-scrollbar {
width: 8px;
}
.screen::-webkit-scrollbar-track {
background: #f1f1f1;
border-radius: 10px;
}
.screen::-webkit-scrollbar-thumb {
background: #ccc;
border-radius: 10px;
}
.screen::-webkit-scrollbar-thumb:hover {
background: #aaa;
}


.screen.active {
display: flex;
opacity: 1;
transform: translateY(0);
}

.btn {
font-family: var(--font-main);
font-size: clamp(1.2rem, 5vw, 2rem);
padding: 15px 30px;
border: none;
border-radius: 10px;
cursor: pointer;
text-transform: uppercase;
letter-spacing: 1px;
transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
width: 100%;
max-width: 300px;
color: var(--color-text-light);
background: var(--color-primary);
background-image: linear-gradient(to right, var(--color-primary) 0%, #0060c0 100%);
border: 2px solid var(--color-text-light);
}

.btn:hover:not(:disabled) {
transform: translateY(-3px);
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
background-image: linear-gradient(to right, #0060c0 0%, var(--color-primary) 100%);
}

.btn:disabled {
background: #999;
cursor: not-allowed;
transform: none;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
background-image: none;
opacity: 0.6;
}


.btn.secondary {
background: var(--color-secondary);
background-image: linear-gradient(to right, var(--color-secondary) 0%, #33c8ff 100%);
margin-top: 10px;
border: 2px solid var(--color-primary);
}
.small-btn {
font-size: 1rem;
max-width: 250px;
padding: 10px 20px;
margin: 15px auto 0 auto;
}

.option-group {
width: 100%;
padding: 15px 0;
border-bottom: 1px dashed #ccc;
}

.count-controls {
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
margin-bottom: 10px;
}

.option-label {
font-family: var(--font-secondary);
font-size: 1.2rem;
font-weight: 700;
color: var(--color-text-dark);
}

.option-value {
font-family: var(--font-main);
font-size: 2.5rem;
color: var(--color-primary);
}

.arrow-btn {
background: transparent;
border: none;
cursor: pointer;
color: var(--color-primary);
font-size: 2rem;
transition: transform 0.2s, color 0.2s;
}

.arrow-btn:hover {
transform: scale(1.2);
color: var(--color-accent);
}

/* Estilos para inputs */
.input-field {
width: 100%;
padding: 10px;
border: 2px solid var(--color-secondary);
border-radius: 8px;
font-size: 1rem;
text-align: center;
transition: border-color 0.2s;
box-sizing: border-box;
max-width: 300px;
}

.input-field:focus {
outline: none;
border-color: var(--color-primary);
}

/* Estilos para el selector de categoría */
#category-selector, #lobby-category-selector {
width: 100%;
padding: 10px;
border: 2px solid var(--color-primary);
border-radius: 8px;
font-size: 1.1rem;
background-color: #f8f8f8;
font-family: var(--font-secondary);
cursor: pointer;
max-width: 300px;
}

/* Estilos para grupo de checkboxes */
.checkbox-group {
display: flex;
flex-direction: column;
align-items: flex-start;
gap: 15px;
padding: 10px 20px;
text-align: left;
width: 100%;
box-sizing: border-box;
max-width: 300px;
margin: 0 auto;
}
.checkbox-group div {
display: flex;
align-items: center;
gap: 10px;
}
.checkbox-group label {
font-family: var(--font-secondary);
font-size: 1.1rem;
font-weight: 500;
color: var(--color-text-dark);
}
.checkbox-group input[type="checkbox"] {
width: 20px;
height: 20px;
cursor: pointer;
}


/* Pantalla de juego */
.game-display {
background-color: #f0f0f0;
border: 4px solid var(--color-primary);
border-radius: 15px;
padding: 40px 20px;
min-height: 200px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
width: 100%;
box-sizing: border-box;
box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
}
#player-name-display {
font-family: var(--font-main);
font-size: clamp(2rem, 8vw, 4rem);
color: var(--color-primary);
animation: fadeIn 0.5s ease-out;
/* Se muestra solo el nombre */
}

#word-display {
font-family: var(--font-main);
font-size: clamp(1.8rem, 7vw, 3.5rem);
color: var(--color-text-dark);
text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
text-transform: uppercase;
text-align: center;
animation: zoomIn 0.3s ease-out;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

.hidden { display: none; }

.impostor-text {
color: var(--color-accent);
animation: pulse 1.5s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}
/* Modal */
.modal {
display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
}
.modal-content {
background-color: #fefefe; padding: 20px; border-radius: 10px; text-align: center;
max-width: 400px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;
}
@keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Estilos de la pantalla final */
#impostor-reveal-btn {
margin-top: 15px;
background-color: #d9534f;
background-image: linear-gradient(to right, #d9534f 0%, #c9302c 100%);
}

#impostor-list {
list-style: none;
padding: 0;
font-family: var(--font-secondary);
font-size: 1.4rem;
font-weight: bold;
color: #c9302c; /* Rojo para los impostores */
margin-top: 10px;
}
#end-message-final {
font-size: 1.2rem;
color: var(--color-text-dark);
}
/* Info de ronda especial */
#special-round-info {
font-size: 1.3rem;
font-weight: bold;
color: var(--color-primary);
margin-top: 10px;
}

/* --- NUEVOS ESTILOS PARA ONLINE --- */
#lobby-room-code {
font-family: var(--font-main);
font-size: 3rem;
color: var(--color-primary);
background: #f0f0f0;
padding: 10px 20px;
border-radius: 10px;
letter-spacing: 3px;
border: 2px dashed var(--color-secondary);
}

#lobby-player-list {
list-style: none;
padding: 0;
margin-top: 15px;
width: 100%;
max-width: 300px;
}

#lobby-player-list li {
font-family: var(--font-secondary);
font-size: 1.2rem;
padding: 8px;
background: #f9f9f9;
border-radius: 5px;
margin-bottom: 5px;
border: 1px solid #eee;
}

#lobby-player-list li .fa-crown {
color: var(--color-accent);
margin-right: 10px;
}

.lobby-config-view {
text-align: left;
padding: 10px 20px;
background: #f0f0f0;
border-radius: 10px;
border: 1px solid #ddd;
width: 100%;
max-width: 350px;
box-sizing: border-box;
}
.lobby-config-view p {
font-family: var(--font-secondary);
font-size: 1.1rem;
margin: 8px 0;
}
.lobby-config-view span {
font-weight: bold;
color: var(--color-primary);
}
</style>
</head>
<body>

<!-- INICIO: Imports de Firebase (Requerido) -->
<script type="module">
    // Importar funciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, arrayUnion, arrayRemove, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // Poner las funciones en el scope global para que el script de abajo las vea
    window.firebase = {
        initializeApp,
        getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, arrayUnion, arrayRemove, runTransaction, serverTimestamp,
        setLogLevel
    };
</script>
<!-- FIN: Imports de Firebase -->


<div class="container">
<!-- Pantalla de inicio -->
<div id="start-screen" class="screen active">
<h1>Impostor Fútbol</h1>
<p>Descubre el impostor entre tus amigos. ¡Que comience el partido!</p>
<button id="start-game-btn" class="btn">Iniciar Partida Local</button>
<!-- Botón Online, se deshabilitará hasta que Firebase esté listo -->
<button id="online-game-btn" class="btn secondary" disabled>Conectando al Servidor...</button>
</div>

<!-- NUEVO: Pantalla de Menú Online -->
<div id="online-menu-screen" class="screen">
<h2>Sala Online</h2>
<p>Introduce tu nombre para jugar online.</p>
<input type="text" id="player-name-input-online" class="input-field" placeholder="Tu Nombre">
<button id="create-room-btn" class="btn">Crear Sala</button>
<button id="join-room-menu-btn" class="btn secondary">Unirse a Sala</button>
<button id="back-to-start-btn" class="btn secondary small-btn">Volver</button>
</div>

<!-- NUEVO: Pantalla de Unirse a Sala -->
<div id="join-room-screen" class="screen">
<h2>Unirse a Sala</h2>
<p>Introduce el código de 6 letras de la sala.</p>
<input type="text" id="room-code-input" class="input-field" placeholder="LERP0W" maxlength="6" style="text-transform: uppercase;">
<button id="submit-join-btn" class="btn">Unirse</button>
<button id="back-to-online-menu-btn" class="btn secondary small-btn">Volver</button>
</div>

<!-- NUEVO: Pantalla de Lobby (Sala de Espera) -->
<div id="lobby-screen" class="screen">
<h2>Sala de Espera</h2>
<p>Código de la Sala:</p>
<div id="lobby-room-code">Cargando...</div>
<h3>Jugadores:</h3>
<ul id="lobby-player-list">
<!-- Jugadores se añaden aquí dinámicamente -->
</ul>

<!-- Controles del Host -->
<div id="lobby-host-controls" class="hidden">
<h3>Configuración (Host)</h3>
<div class="option-group">
<div class="count-controls">
<button class="arrow-btn" id="lobby-impostors-minus" aria-label="Disminuir impostores"><i class="fas fa-arrow-left"></i></button>
<div>
<div class="option-label">Impostores</div>
<div class="option-value" id="lobby-impostor-count-display">1</div>
</div>
<button class="arrow-btn" id="lobby-impostors-plus" aria-label="Aumentar impostores"><i class="fas fa-arrow-right"></i></button>
</div>
</div>
<div class="option-group">
<div class="option-label">Tema</div>
<select id="lobby-category-selector">
<option value="players">Jugadores de Fútbol</option>
<option value="clubs">Clubes de Fútbol</option>
<option value="clashroyale">Cartas de Clash Royale</option>
<option value="f1Pilots">Pilotos de F1</option>
<option value="alumnos3ro">Alumnos 3ro</option>
<option value="genteColegio">Gente del Colegio</option>
<option value="profes">Profesores</option>
<option value="cosasCotidianas">Cosas Cotidianas</option>
<option value="random">Al Azar</option>
</select>
</div>
<div class="option-group checkbox-group">
<div>
<input type="checkbox" id="lobby-special-rounds-check">
<label for="lobby-special-rounds-check">Rondas Especiales</label>
</div>
<div>
<input type="checkbox" id="lobby-impostor-knows-check" checked>
<label for="lobby-impostor-knows-check">Impostor Sabe</label>
</div>
</div>
<button id="lobby-start-game-btn" class="btn">Iniciar Partida</button>
</div>

<!-- Vista para Invitados -->
<div id="lobby-joiner-view" class="hidden">
<h3>Configuración (Host):</h3>
<div class="lobby-config-view">
<p>Impostores: <span id="view-impostor-count">1</span></p>
<p>Categoría: <span id="view-category">Jugadores de Fútbol</span></p>
<p>Rondas Especiales: <span id="view-special-rounds">No</span></p>
<p>Impostor Sabe: <span id="view-impostor-knows">Sí</span></p>
</div>
<p><i>Esperando a que el host inicie la partida...</i></p>
</div>
<button id="lobby-leave-btn" class="btn secondary small-btn">Salir de la Sala</button>
</div>


<!-- Pantalla de configuración (Local) -->
<div id="config-screen" class="screen">
<h2>Configuración (Local)</h2>
<!-- Cantidad de jugadores -->
<div class="option-group">
<div class="count-controls">
<button class="arrow-btn" id="players-minus" aria-label="Disminuir jugadores"><i class="fas fa-arrow-left"></i></button>
<div>
<div class="option-label">Jugadores</div>
<div class="option-value" id="player-count-display">3</div>
</div>
<button class="arrow-btn" id="players-plus" aria-label="Aumentar jugadores"><i class="fas fa-arrow-right"></i></button>
</div>
<button id="toggle-names-btn" class="btn secondary small-btn">Cambiar nombres de jugadores</button>
<div id="player-names-container" class="hidden">
</div>
</div>
<!-- Cantidad de impostores -->
<div class="option-group">
<div class="count-controls">
<button class="arrow-btn" id="impostors-minus" aria-label="Disminuir impostores"><i class="fas fa-arrow-left"></i></button>
<div>
<div class="option-label">Impostores</div>
<div class="option-value" id="impostor-count-display">1</div>
</div>
<button class="arrow-btn" id="impostors-plus" aria-label="Aumentar impostores"><i class="fas fa-arrow-right"></i></button>
</div>
</div>
<!-- Selector de categoría -->
<div class="option-group">
<div class="option-label">Tema de la Palabra</div>
<select id="category-selector">
<option value="players">Jugadores de Fútbol</option>
<option value="clubs">Clubes de Fútbol</option>
<option value="clashroyale">Cartas de Clash Royale</option>
<option value="f1Pilots">Pilotos de F1</option>
<option value="alumnos3ro">Alumnos 3ro</option>
<option value="genteColegio">Gente del Colegio</option>
<option value="profes">Profesores</option>
<option value="cosasCotidianas">Cosas Cotidianas</option>
<option value="random">Al Azar</option>
</select>
</div>
<!-- Opciones de Juego -->
<div class="option-group checkbox-group">
<div>
<input type="checkbox" id="special-rounds-check">
<label for="special-rounds-check">Habilitar Rondas Especiales</label>
</div>
<div>
<input type="checkbox" id="impostor-knows-check" checked>
<label for="impostor-knows-check">El impostor sabe que es impostor</label>
</div>
</div>
<button id="start-round-btn" class="btn">Iniciar Partida</button>
<button id="back-to-start-btn-local" class="btn secondary small-btn">Volver</button>
</div>

<!-- Pantalla de juego (mostrar palabra) -->
<div id="word-screen" class="screen">
<h2 id="player-name-display">Es el turno de...</h2>
<div class="game-display">
<button id="show-word-btn" class="btn">Mostrar Palabra</button>
<p id="word-display" class="hidden"></p>
</div>
<button id="next-player-btn" class="btn secondary">Siguiente Jugador</button>
</div>
<!-- Pantalla final -->
<div id="end-screen" class="screen">
<h2>¡Final de la Ronda!</h2>
<p id="end-message-initial">Ahora es momento de discutir y votar. ¿Quién te pareció el más sospechoso?</p>
<button id="impostor-reveal-btn" class="btn">Revelar Impostores</button>
<div id="reveal-area" class="hidden">
<p id="special-round-info" class="hidden"></p>
<p id="end-message-final">Los impostores eran:</p>
<ul id="impostor-list"></ul>
</div>

<button id="play-again-btn" class="btn">Jugar de Nuevo</button>
<button id="change-settings-btn" class="btn secondary">Cambiar Ajustes</button>
</div>

</div>
<!-- Modal para mensajes de error o información -->
<div id="message-modal" class="modal">
<div class="modal-content">
<p id="modal-text"></p>
<button id="modal-close-btn" class="btn">Entendido</button>
</div>
</div>

<!-- Audio de alarma (debe estar fuera del container) -->
<audio id="alarm-sound" src="placeholder_alarm.mp3" loop preload="auto"></audio>


<script type="module">
// --- Firebase (globales) ---
// Estas variables se llenarán con la inicialización de Firebase
let db, auth, userId, userName, appId, roomsPath;
let currentRoomId = null;
let isHost = false;
let roomUnsubscribe = null; // Para detener el listener de Firestore
let isFirebaseReady = false; // Flag para confirmar que la autenticación terminó

// --- BASE DE DATOS DE PALABRAS ---
const playersList = [
"Lionel Messi", "Cristiano Ronaldo", "Diego Maradona", "Pelé", "Zinedine Zidane",
"Ronaldo Nazário", "Johan Cruyff", "Franz Beckenbauer", "Garrincha", "Denzel Dumfries",
"Alfredo Di Stéfano", "Ferenc Puskás", "Zlatan Ibrahimovic", "Marco van Basten", "Zlatan Ibrahimović",
"Andrés Iniesta", "Xavi Hernández", "Ronaldinho Gaúcho", "Neymar Jr.", "Kylian Mbappé",
"Erling Haaland", "Luka Modrić", "Kevin De Bruyne", "Mohamed Salah", "Robert Lewandowski",
"Sergio Ramos", "Virgil van Dijk", "Manuel Neuer", "Alisson Becker", "Marc-André ter Stegen",
"Paulo Dybala", "Ángel Di María", "Lautaro Martínez", "Julián Álvarez", "Frank Fabra",
"N'Golo Kanté", "Sadio Mané", "Harry Kane", "Son Heung-min", "Thierry Henry",
"Didier Drogba", "Samuel Eto'o", "Arjen Robben", "Franck Ribéry", "Carles Puyol",
"Gerard Piqué", "Andrea Pirlo", "Gianluigi Buffon", "Iker Casillas", "David Beckham",
"Kaká", "Wayne Rooney", "Frank Lampard", "Steven Gerrard", "Paolo Maldini",
"Roberto Baggio", "Gabriel Batistuta", "Federico Chiesa", "Romario", "Bebeto",
"Javier Zanetti", "Gonzalo Montiel", "Juan Román Riquelme", "Carlos Tévez", "Sergio Agüero",
"Diego Simeone", "Alan Velasco", "Mascherano", "Javier Saviola", "Pablo Aimar",
"Radamel Falcao", "James Rodríguez", "Luis Suárez", "Edinson Cavani", "Arturo Vidal",
"Alexis Sánchez", "Claudio Bravo", "Keylor Navas", "Christian Pulisic",
"Rodrigo De Paul", "Chicharito Hernández",
"Guillermo Ochoa", "Francesco Totti", "Alessandro Del Piero", "Giorgio Chiellini",
"Leonardo Bonucci", "Nahuel Molina", "Mario Balotelli", "Paul Pogba", "Antoine Griezmann",
"Karim Benzema", "Vinícius Jr.", "Rodrygo", "Federico Valverde", "Casemiro",
"Toni Kroos", "Thomas Müller", "Joshua Kimmich", "Manuel Neuer", "Mesut Özil",
"Marco Reus", "Leroy Sané", "Kai Havertz", "Timo Werner", "Mats Hummels",
"Jude Bellingham", "Phil Foden", "Jack Grealish", "Marcus Rashford", "Bukayo Saka",
"Mason Mount", "Declan Rice", "Trent Alexander-Arnold", "Kyle Walker", "Raheem Sterling",
"Hakim Ziyech", "Achraf Hakimi", "Riyad Mahrez", "André Onana",
"Christian Eriksen", "Pierre-Emerick Aubameyang",
"Heung-Min Son", "Miguel Merentiel",
"Ivan Rakitić", "Josko Gvardiol", "Gareth Bale",
"Frank Fabra", "Raúl Asencio", "Hugo Lloris", "Richarlison",
"Bruno Fernandes", "Bernardo Silva", "João Félix", "Rúben Dias", "Raphael Varane",
"Raphael Guerreiro", "João Cancelo", "Gonçalo Ramos", "Vitinha", "Darwin Núñez",
"Luis Díaz", "Luis Muriel", "Juan Guillermo Cuadrado", "David Ospina", "David Neres",
"Antony", "Fred", "Gabriel Martinelli", "Gabriel Jesus", "Vini Jr",
"Sergio Busquets", "Jordi Alba", "Ferran Torres", "Gavi", "Pedri",
"Emiliano Martínez", "Alejandro Garnacho", "Nico Otamendi"
];
const clubsList = [
"Real Madrid", "FC Barcelona", "Manchester United", "Liverpool FC", "Bayern Múnich",
"Juventus FC", "AC Milán", "Inter de Milán", "París Saint-Germain", "Manchester City",
"Chelsea FC", "Arsenal FC", "Atlético de Madrid", "Borussia Dortmund", "Ajax Ámsterdam",
"River Plate", "Boca Juniors", "Independiente", "Racing Club", "San Lorenzo",
"São Paulo FC", "CR Flamengo", "SE Palmeiras", "Club América", "Chivas Guadalajara",
"Inter Miami", "New York City FC", "Benfica", "FC Porto", "Sporting CP",
"Olympique de Lyon", "Olympique de Marsella", "AS Mónaco", "Galatasaray SK", "Fenerbahçe SK",
"Besiktas JK", "Celtic FC", "Rangers FC", "Napoli", "AS Roma",
"Valencia CF", "Sevilla FC", "Real Betis", "Tottenham Hotspur", "Leicester City",
"West Ham United", "Everton FC", "Bayer Leverkusen", "RB Leipzig", "Schalke 04"
];
const clashRoyaleList = [
"Gigante Eléctrico", "Montapuercos", "P.E.K.K.A", "Mago Eléctrico", "Mini P.E.K.K.A",
"Príncipe", "Princesa", "Caballero", "Valquiria", "Bruja",
"Bebé Dragón", "Esqueleto Gigante", "Golem", "Sabueso de Lava", "Dragón Infernal",
"Cementerio", "Tronco", "Bola de Fuego", "Rayo", "Cohete",
"Descarga", "Flechas", "Veneno", "Tornado", "Emperatriz Espiritual",
"Pandilla de Duendes", "Esqueletos", "Murciélagos", "Espíritu de Hielo", "Espíritu de Fuego",
"Arqueras", "Mosquetera", "Duendes con Lanza", "Duendes", "Mega Esbirro",
"Trío de Mosqueteras", "Bárbaros de Élite", "Mago de Hielo", "Leñador", "Bandida",
"Furia", "Clon", "Espejo", "Recolector de Elixir", "Torre Infierno",
"Ballesta", "Mortero", "Horno", "Jaula del Forzudo", "Ariete de Batalla",
"Barril de Duendes", "Barril de Esqueletos", "Globo", "Minero", "Puerco Gigante",
"Curandera Guerrera", "Torre Tesla", "Choza de Bárbaros", "Torre Bombardera", "Rey Esqueleto"
];
const f1PilotsList = [
"Max Verstappen", "Lewis Hamilton", "Charles Leclerc", "Lando Norris", "Fernando Alonso",
"Sergio Pérez", "George Russell", "Carlos Sainz", "Oscar Piastri", "Daniel Ricciardo",
"Sebastian Vettel", "Michael Schumacher", "Ayrton Senna", "Alain Prost", "Niki Lauda",
"Franco Colapinto", "Juan Manuel Fangio", "Kimi Räikkönen", "Jenson Button", "Nico Rosberg",
"Valtteri Bottas", "Esteban Ocon", "Pierre Gasly", "Yuki Tsunoda", "Lance Stroll",
"Alexander Albon", "Kevin Magnussen", "Nico Hülkenberg", "Zhou Guanyu", "Logan Sargeant", "Jack Doohan"
];
const alumnos3roList = [
"Bauti", "Beltina", "Bernardita", "Guada Molina", "Simon Carranza", "Emma Llugdar", 
"Emma Carabajal", "Fabri", "Felipon", "Fran", "Gae", "Guada Elias", "Jana", "Jazmin", 
"Jere", "Juana", "Lara", "Lola", "Lolo", "Lucia", "Masao", "Mateo", "Matias", 
"Santi Hiller", "Nika", "Julia", "Olivia", "Pedro", "Santino", "Simon Abbadie", 
"Sofia", "Thiago Michiels", "Valentina", "Victoria"
];
const genteColegioList = [
"Bauti", "Beltina", "Bernardita", "Guada Molina", "Simon Carranza", "Emma Llugdar", 
"Emma Carabajal", "Fabri", "Felipon", "Fran", "Gae", "Guada Elias", "Jana", "Jazmin", 
"Jere", "Juana", "Lara", "Lola", "Lolo", "Lucia", "Masao", "Mateo", "Matias", 
"Santi Hiller", "Nika", "Julia", "Olivia", "Pedro", "Santino", "Simon Abbadie", 
"Sofia", "Thiago Michiels", "Valentina", "Victoria", "La suplente de PDL", 
"Diana Justel (Profe de Ingles)", "Mara Camba (Profe de Ingles)", "Cintia Milano (Profe de Plastica)", 
"Vicky Lasarte (Profe de Matematica)", "Julieta Levis (Profe de Matematica)", 
"Debora Alvarez (Profe de Matematica)", "Cyntia de La Vega (Profe de Matematica)", 
"Francisco Santillan (Profe de Historia)", "Angie Diz (Profe de PDL)", 
"Mariana Fernandez (Profe de Biologia)", "Estefania Maffei (Profe de Biologia)", 
"Marcelo (Profe de Primaria Turno Mañana)", "Eugenia Huinchulef (Profe de Construccion de Ciudadania)", 
"Cintia Olsen (Profe de Taller)", "Carmen (Profe de Teatro y Ciudadania)", 
"Rocio Maldini (Profe de Fisico-Quimica)", "Quesadilla", "Gero (Hermano de Ramiro Ali)", 
"Jano (1ro)", "Uma (Hermana de Jana)", "Tizi (Hermana de Lolo)", "Ramiro", "Felipe Sanchez", 
"Joaco Lopez", "Thiago Barcala", "Simon Contartese", "Juanse", "Ezequiel", "Luisiana", 
"Milo", "Manuel Saucedo", "Julia Franchini", "Alma (Bolivar)", "Lucas (Preceptor)", 
"Giuli (Preceptora)", "Noe (Preceptora)", "Isis (Preceptora)", "Agucho (Recepción)"
];
const profesList = [
"La suplente de PDL", "Diana Justel (Profe de Ingles)", "Mara Camba (Profe de Ingles)", 
"Cintia Milano (Profe de Plastica)", "Vicky Lasarte (Profe de Matematica)", 
"Julieta Levis (Profe de Matematica)", "Debora Alvarez (Profe de Matematica)", 
"Cyntia de La Vega (Profe de Matematica)", "Francisco Santillan (Profe de Historia)", 
"Angie Diz (Profe de PDL)", "Mariana Fernandez (Profe de Biologia)", 
"Estefania Maffei (Profe de Biologia)", "Marcelo (Profe de Primaria Turno Mañana)", 
"Eugenia Huinchulef (Profe de Construccion de Ciudadania)", "Cintia Olsen (Profe de Taller)", 
"Carmen (Profe de Teatro y Ciudadania)", "Rocio Maldini (Profe de Fisico-Quimica)", 
"Tic (Profe de Tecnologia)", "Lucia di Gregori (Profe de Ingles 1ro)", "Pedro (Suplente Matematica)"
];
const cosasCotidianasList = [
"Lápiz", "Goma de borrar", "Cuaderno", "Pizarrón", "Tiza", "Marcador", "Mochila", 
"Cartuchera", "Silla", "Mesa", "Computadora", "Celular", "Llaves", "Vaso", "Plato", 
"Tenedor", "Cuchillo", "Cuchara", "Botella de agua", "Zapatillas", "Remera", "Pantalón", 
"Reloj", "Anteojos", "Cama", "Almohada", "Puerta", "Ventana", "Foco", "Lámpara", 
"Libro", "Sofá", "Televisor", "Auto", "Bicicleta", "Colectivo", "Semáforo", "Árbol", 
"Pasto", "Nube", "Sol", "Luna", "Cepillo de dientes", "Ducha", "Jabón", "Shampoo"
];
// Listas de palabras unificadas para acceso global
const allWordLists = {
    players: playersList,
    clubs: clubsList,
    clashroyale: clashRoyaleList,
    f1Pilots: f1PilotsList,
    alumnos3ro: alumnos3roList,
    genteColegio: genteColegioList,
    profes: profesList,
    cosasCotidianas: cosasCotidianasList
};

// --- VARIABLES DE ESTADO (JUEGO LOCAL) ---
let playerCount = 3;
let impostorCount = 1;
let playerNames = ["Jugador 1", "Jugador 2", "Jugador 3"]; // Nombres para el juego (local o sincronizado)
let impostorIndices = [];
let wordForPlayers = "";
let wordForImpostor = "";
let currentPlayerIndex = 0;
let selectedCategory = "players";
let enableSpecialRounds = false;
let impostorKnows = true;
let currentRoundType = "normal";

// --- REFERENCIAS DEL DOM (Pantallas) ---
const startScreen = document.getElementById('start-screen');
const configScreen = document.getElementById('config-screen');
const wordScreen = document.getElementById('word-screen');
const endScreen = document.getElementById('end-screen');
const messageModal = document.getElementById('message-modal');
// Nuevas pantallas online
const onlineMenuScreen = document.getElementById('online-menu-screen');
const joinRoomScreen = document.getElementById('join-room-screen');
const lobbyScreen = document.getElementById('lobby-screen');

// --- REFERENCIAS DEL DOM (Botones Inicio) ---
const startGameBtn = document.getElementById('start-game-btn');
const onlineGameBtn = document.getElementById('online-game-btn');
const backToStartBtn = document.getElementById('back-to-start-btn');
const backToStartBtnLocal = document.getElementById('back-to-start-btn-local');

// --- REFERENCIAS DEL DOM (Menú Online) ---
const playerNameInputOnline = document.getElementById('player-name-input-online');
const createRoomBtn = document.getElementById('create-room-btn');
const joinRoomMenuBtn = document.getElementById('join-room-menu-btn');
const roomCodeInput = document.getElementById('room-code-input');
const submitJoinBtn = document.getElementById('submit-join-btn');
const backToOnlineMenuBtn = document.getElementById('back-to-online-menu-btn');

// --- REFERENCIAS DEL DOM (Lobby) ---
const lobbyRoomCode = document.getElementById('lobby-room-code');
const lobbyPlayerList = document.getElementById('lobby-player-list');
const lobbyHostControls = document.getElementById('lobby-host-controls');
const lobbyJoinerView = document.getElementById('lobby-joiner-view');
const lobbyImpostorsMinus = document.getElementById('lobby-impostors-minus');
const lobbyImpostorsPlus = document.getElementById('lobby-impostors-plus');
const lobbyImpostorCountDisplay = document.getElementById('lobby-impostor-count-display');
const lobbyCategorySelector = document.getElementById('lobby-category-selector');
const lobbySpecialRoundsCheck = document.getElementById('lobby-special-rounds-check');
const lobbyImpostorKnowsCheck = document.getElementById('lobby-impostor-knows-check');
const lobbyStartGameBtn = document.getElementById('lobby-start-game-btn');
const lobbyLeaveBtn = document.getElementById('lobby-leave-btn');
// Vistas de solo lectura para invitados
const viewImpostorCount = document.getElementById('view-impostor-count');
const viewCategory = document.getElementById('view-category');
const viewSpecialRounds = document.getElementById('view-special-rounds');
const viewImpostorKnows = document.getElementById('view-impostor-knows');


// --- REFERENCIAS DEL DOM (Config Local) ---
const playersMinusBtn = document.getElementById('players-minus');
const playersPlusBtn = document.getElementById('players-plus');
const impostorsMinusBtn = document.getElementById('impostors-minus');
const impostorsPlusBtn = document.getElementById('impostors-plus');
const toggleNamesBtn = document.getElementById('toggle-names-btn');
const playerCountEl = document.getElementById('player-count-display');
const impostorCountEl = document.getElementById('impostor-count-display');
const playerNamesContainer = document.getElementById('player-names-container');
const categorySelector = document.getElementById('category-selector');
const specialRoundsCheck = document.getElementById('special-rounds-check');
const impostorKnowsCheck = document.getElementById('impostor-knows-check');
const startRoundBtn = document.getElementById('start-round-btn');

// --- REFERENCIAS DEL DOM (Juego) ---
const playerNameDisplayEl = document.getElementById('player-name-display');
const wordDisplayEl = document.getElementById('word-display');
const showWordBtn = document.getElementById('show-word-btn');
const nextPlayerBtn = document.getElementById('next-player-btn');

// --- REFERENCIAS DEL DOM (Final) ---
const impostorRevealBtn = document.getElementById('impostor-reveal-btn');
const revealArea = document.getElementById('reveal-area');
const specialRoundInfoEl = document.getElementById('special-round-info');
const endMessageInitialEl = document.getElementById('end-message-initial');
const endMessageFinal = document.getElementById('end-message-final');
const impostorListEl = document.getElementById('impostor-list');
const playAgainBtn = document.getElementById('play-again-btn');
const changeSettingsBtn = document.getElementById('change-settings-btn');

// --- REFERENCIAS DEL DOM (Otros) ---
const modalText = document.getElementById('modal-text');
const modalCloseBtn = document.getElementById('modal-close-btn');
const alarmSound = document.getElementById('alarm-sound');


// --- FUNCIONES DE INTERFAZ ---
function showMessage(message) {
modalText.textContent = message;
messageModal.style.display = 'flex';
}
modalCloseBtn.addEventListener('click', () => {
messageModal.style.display = 'none';
});

function showScreen(screen) {
document.querySelectorAll('.screen').forEach(s => {
s.classList.remove('active');
});
screen.classList.add('active');
}

// Detener alarma (función de ayuda)
function stopAlarm() {
    document.body.classList.remove('impostor-alarm');
    alarmSound.pause();
    if (alarmSound.currentTime) {
        alarmSound.currentTime = 0;
    }
}

// --- FUNCIÓN DE UTILIDAD: RETRY CON EXPONENTIAL BACKOFF ---
async function retryOperation(fn, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            const delay = Math.pow(2, i) * 1000 + Math.random() * 500; // 1s, 2s, 4s (+ jitter)
            console.log(`Retry attempt ${i + 1} failed. Retrying in ${delay.toFixed(0)}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

// --- FUNCIONES DE FIREBASE (ACTUALIZADAS PARA SER MÁS ROBUSTAS) ---
async function initFirebase() {
    // 1. Configuración de Variables
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let firebaseConfig;
    try {
        firebaseConfig = JSON.parse(firebaseConfigString);
    } catch (e) {
        console.error("Firebase: Error al parsear la configuración. El servidor está mal configurado o faltan variables.");
        onlineGameBtn.textContent = "ERROR: Configuración Inválida";
        onlineGameBtn.disabled = true;
        showMessage("El servidor no pudo ser configurado (JSON inválido). El modo online está desactivado.");
        isFirebaseReady = false;
        return;
    }

    if (!firebaseConfig.apiKey) {
        console.error("Firebase: No se encontró apiKey. Es probable que la configuración no esté disponible.");
        onlineGameBtn.textContent = "ERROR: Configuración Faltante";
        onlineGameBtn.disabled = true;
        showMessage("El entorno no proporcionó la configuración de Firebase necesaria. El modo online está desactivado.");
        isFirebaseReady = false;
        return;
    }
    
    // 2. Establecer UI a estado de carga
    onlineGameBtn.textContent = "Conectando al Servidor...";
    onlineGameBtn.disabled = true;

    // 3. Inicializar Firebase
    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel } = window.firebase;

    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    setLogLevel('Debug'); // Para ver logs de Firestore
    
    roomsPath = `/artifacts/${appId}/public/data/impostor_rooms`;

    try {
        // 4. Intentar la Autenticación con reintentos
        const signInTask = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                console.log("Firebase: Intentando signInWithCustomToken...");
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                console.log("Firebase: Intentando signInAnonymously...");
                await signInAnonymously(auth);
            }
        };
        
        await retryOperation(signInTask, 3);
        console.log("Firebase: Autenticación inicial exitosa o completada.");
        
        // 5. Esperar la confirmación final del estado de autenticación (onAuthStateChanged)
        await new Promise((resolve, reject) => {
            // Establecer un timeout de respaldo en caso de que onAuthStateChanged nunca se dispare
            const timeout = setTimeout(() => {
                unsubscribe();
                reject(new Error("onAuthStateChanged timeout. No se pudo confirmar el estado de auth en 8 segundos."));
            }, 8000); // 8 segundos de espera
            
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                clearTimeout(timeout);
                if (user) {
                    userId = user.uid;
                    console.log("Firebase: Conexión y Auth confirmada. UID:", userId);
                } else {
                    // Esto no debería ocurrir si el signIn fue exitoso, pero lo manejamos
                    console.warn("Firebase: onAuthStateChanged completado, pero el usuario no está logueado.");
                    userId = 'guest-' + crypto.randomUUID(); // Fallback ID
                }
                
                isFirebaseReady = true;
                onlineGameBtn.textContent = "Sala Online";
                onlineGameBtn.disabled = false;
                
                unsubscribe();
                resolve();
            }, (error) => {
                clearTimeout(timeout);
                unsubscribe();
                reject(error);
            });
        });
        
    } catch (error) {
        // 6. Falla crítica
        console.error("Firebase: Falla crítica de conexión/autenticación final:", error.message || error);
        showMessage(`Fallo crítico al conectar al servidor: ${error.message || 'Error desconocido'}. El modo online está deshabilitado.`);
        onlineGameBtn.textContent = "ERROR: Conexión Fallida";
        onlineGameBtn.disabled = true;
        isFirebaseReady = false;
    }
}

function generateRoomCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// Función principal de escucha de la sala
function listenToRoom(roomId) {
    const { doc, onSnapshot } = window.firebase;
    currentRoomId = roomId;
    
    // Si ya hay un listener, detenerlo
    if (roomUnsubscribe) roomUnsubscribe();

    const roomRef = doc(db, roomsPath, roomId);
    roomUnsubscribe = onSnapshot(roomRef, (docSnap) => {
        if (!docSnap.exists()) {
            showMessage("La sala ha sido cerrada por el host.");
            leaveRoom();
            return;
        }

        const roomData = docSnap.data();
        
        // Sincronizar UI del Lobby
        if (lobbyScreen.classList.contains('active')) {
            lobbyRoomCode.textContent = roomId;
            lobbyPlayerList.innerHTML = '';
            roomData.players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.name;
                if (player.userId === roomData.hostId) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-crown';
                    li.prepend(icon);
                }
                lobbyPlayerList.appendChild(li);
            });

            // Mostrar controles de host o vista de invitado
            lobbyHostControls.style.display = isHost ? 'block' : 'none';
            lobbyJoinerView.style.display = isHost ? 'none' : 'block';

            // Actualizar vista de invitado
            if (!isHost) {
                viewImpostorCount.textContent = roomData.config.impostorCount;
                const categoryOption = lobbyCategorySelector.querySelector(`option[value="${roomData.config.category}"]`);
                viewCategory.textContent = categoryOption ? categoryOption.text : roomData.config.category;
                viewSpecialRounds.textContent = roomData.config.specialRounds ? 'Sí' : 'No';
                viewImpostorKnows.textContent = roomData.config.impostorKnows ? 'Sí' : 'No';
            }
            
            // Habilitar/deshabilitar botón de empezar
            lobbyStartGameBtn.disabled = roomData.players.length < 3;
        }
        
        // Sincronizar inicio del juego
        // Si el estado es "playing" y *no* estamos ya en la pantalla de juego
        if (roomData.gameState.status === 'playing' && !wordScreen.classList.contains('active')) {
            console.log("Iniciando juego desde Firestore...");
            // Cargar estado del juego desde Firestore a las variables locales
            const gs = roomData.gameState;
            wordForPlayers = gs.wordForPlayers;
            wordForImpostor = gs.wordForImpostor;
            impostorIndices = gs.impostorIndices;
            currentRoundType = gs.currentRoundType;
            
            // Cargar jugadores desde el lobby
            playerNames = roomData.players.map(p => p.name);
            playerCount = playerNames.length;
            
            // Configuración
            impostorCount = roomData.config.impostorCount;
            selectedCategory = roomData.config.category;
            enableSpecialRounds = roomData.config.specialRounds;
            impostorKnows = roomData.config.impostorKnows;
            
            currentPlayerIndex = 0; // Siempre empieza el primero
            updateWordScreenUI();
            showScreen(wordScreen);
        }
        
        // Sincronizar vuelta al lobby
        if (roomData.gameState.status === 'lobby' && !lobbyScreen.classList.contains('active')) {
             console.log("Volviendo al lobby...");
             stopAlarm();
             showScreen(lobbyScreen);
        }
    });
}

// Crear una sala (Host)
async function handleCreateRoom() {
    const { setDoc, doc, serverTimestamp } = window.firebase;
    
    userName = playerNameInputOnline.value.trim() || `Jugador ${userId.substring(0, 4)}`;
    if (!userName) {
        showMessage("Por favor, introduce un nombre.");
        return;
    }
    
    const roomId = generateRoomCode();
    isHost = true;
    
    // Configuración inicial (la que está en los controles del lobby por defecto)
    const initialConfig = {
        impostorCount: 1,
        category: 'players',
        specialRounds: false,
        impostorKnows: true
    };
    
    const roomData = {
        hostId: userId,
        players: [{ userId: userId, name: userName }],
        config: initialConfig,
        gameState: { status: 'lobby' },
        createdAt: serverTimestamp() // Opcional, para limpiar salas viejas
    };
    
    try {
        const roomRef = doc(db, roomsPath, roomId);
        await setDoc(roomRef, roomData);
        listenToRoom(roomId);
        showScreen(lobbyScreen);
    } catch (error) {
        console.error("Error al crear la sala:", error);
        showMessage("Error al crear la sala. Inténtalo de nuevo.");
    }
}

// Unirse a una sala (Invitado)
async function handleJoinRoom() {
    const { doc, getDoc, updateDoc, arrayUnion } = window.firebase;
    
    userName = playerNameInputOnline.value.trim() || `Jugador ${userId.substring(0, 4)}`;
    if (!userName) {
        showMessage("Por favor, introduce un nombre en el menú anterior.");
        showScreen(onlineMenuScreen);
        return;
    }
    
    const roomId = roomCodeInput.value.toUpperCase();
    if (roomId.length !== 6) {
        showMessage("El código debe tener 6 letras.");
        return;
    }

    const roomRef = doc(db, roomsPath, roomId);
    
    try {
        const docSnap = await getDoc(roomRef);
        if (!docSnap.exists()) {
            showMessage("No se encontró ninguna sala con ese código.");
            return;
        }
        
        const roomData = docSnap.data();
        if (roomData.players.length >= 34) { // Límite de jugadores
             showMessage("La sala está llena.");
             return;
        }

        if (roomData.gameState.status !== 'lobby') {
            showMessage("La partida ya ha comenzado.");
            return;
        }

        // Añadir jugador
        await updateDoc(roomRef, {
            players: arrayUnion({ userId: userId, name: userName })
        });
        
        isHost = false;
        listenToRoom(roomId);
        showScreen(lobbyScreen);
        
    } catch (error) {
        console.error("Error al unirse a la sala:", error);
        showMessage("Error al unirse a la sala. Verifica el código.");
    }
}

// Salir de la sala (Host o Invitado)
async function leaveRoom() {
    const { doc, updateDoc, deleteDoc, arrayRemove } = window.firebase;
    
    if (roomUnsubscribe) {
        roomUnsubscribe(); // Deja de escuchar
        roomUnsubscribe = null;
    }
    
    if (currentRoomId) {
        const roomRef = doc(db, roomsPath, currentRoomId);
        if (isHost) {
            // Si soy el host, borro la sala
            await deleteDoc(roomRef).catch(e => console.error("Error al borrar sala:", e));
        } else {
            // Si soy invitado, me quito de la lista
            await updateDoc(roomRef, {
                players: arrayRemove({ userId: userId, name: userName })
            }).catch(e => console.error("Error al salir de la sala:", e));
        }
    }
    
    currentRoomId = null;
    isHost = false;
    showScreen(startScreen);
}

// Función del Host para actualizar la config en Firestore
async function updateLobbyConfig() {
    if (!isHost || !currentRoomId) return;
    
    const { doc, updateDoc } = window.firebase;
    const roomRef = doc(db, roomsPath, currentRoomId);

    // Leer valores de los controles del lobby
    const config = {
        impostorCount: parseInt(lobbyImpostorCountDisplay.textContent),
        category: lobbyCategorySelector.value,
        specialRounds: lobbySpecialRoundsCheck.checked,
        impostorKnows: lobbyImpostorKnowsCheck.checked
    };
    
    try {
        await updateDoc(roomRef, { config: config });
    } catch (e) {
        console.error("Error al actualizar config:", e);
    }
}

// Función del Host para iniciar la partida
async function handleOnlineStartGame() {
    if (!isHost || !currentRoomId) return;
    
    const { doc, getDoc, updateDoc } = window.firebase;
    const roomRef = doc(db, roomsPath, currentRoomId);
    
    try {
        const docSnap = await getDoc(roomRef);
        if (!docSnap.exists()) return;
        
        const roomData = docSnap.data();
        
        // Cargar variables locales con la config de la sala
        playerNames = roomData.players.map(p => p.name);
        playerCount = playerNames.length;
        impostorCount = roomData.config.impostorCount;
        selectedCategory = roomData.config.category;
        enableSpecialRounds = roomData.config.specialRounds;
        impostorKnows = roomData.config.impostorKnows;

        if (playerCount < 3) {
            showMessage("Necesitas al menos 3 jugadores para empezar.");
            return;
        }
        if (impostorCount >= playerCount) {
            showMessage("Debe haber menos impostores que jugadores.");
            return;
        }

        // Ejecutar la lógica local de setup
        setupGame();
        
        // Crear el nuevo estado de juego para guardar en Firestore
        const newGameState = {
            status: 'playing',
            wordForPlayers: wordForPlayers,
            wordForImpostor: wordForImpostor,
            impostorIndices: impostorIndices,
            currentRoundType: currentRoundType,
            // Nota: playerNames y playerCount se leen de la lista de players
        };
        
        // Actualizar el documento
        await updateDoc(roomRef, { gameState: newGameState });
        
        // El onSnapshot se encargará de mover al host y a los clientes a la pantalla de juego
        
    } catch (error) {
        console.error("Error al iniciar la partida online:", error);
    }
}

// Función del Host para volver al lobby
async function handleBackToLobby() {
    if (!isHost || !currentRoomId) return;

    const { doc, updateDoc } = window.firebase;
    const roomRef = doc(db, roomsPath, currentRoomId);
    
    try {
        await updateDoc(roomRef, {
            'gameState.status': 'lobby'
        });
        // El onSnapshot moverá a todos al lobby
    } catch (e) {
        console.error("Error al volver al lobby:", e);
    }
}


// --- LÓGICA DE JUEGO (LOCAL) ---
// Esta lógica ahora es usada por el juego local,
// Y también por el HOST del juego online para preparar la ronda.

function setupGame() {
    currentPlayerIndex = 0;
    impostorIndices = [];
    wordForPlayers = "";
    wordForImpostor = "";
    currentRoundType = "normal";
    stopAlarm();
    
    // 1. Elegir la lista de palabras
    let wordList;
    if (selectedCategory === 'random') {
        const allLists = Object.values(allWordLists);
        wordList = allLists[Math.floor(Math.random() * allLists.length)];
    } else {
        wordList = allWordLists[selectedCategory];
    }

    // 2. Verificar Rondas Especiales
    if (enableSpecialRounds && Math.random() < 0.25) {
        const specialType = Math.floor(Math.random() * 4);
        
        switch (specialType) {
            case 0:
                currentRoundType = "Todos Impostores";
                impostorIndices = Array.from({length: playerCount}, (_, i) => i);
                wordForImpostor = "IMPOSTOR";
                wordForPlayers = "IMPOSTOR";
                break;
            case 1:
                currentRoundType = "Nadie es Impostor";
                impostorIndices = [];
                wordForPlayers = wordList[Math.floor(Math.random() * wordList.length)];
                break;
            case 2:
                currentRoundType = "Todos menos uno Impostor";
                const luckyPlayer = Math.floor(Math.random() * playerCount);
                impostorIndices = Array.from({length: playerCount}, (_, i) => i).filter(i => i !== luckyPlayer);
                wordForPlayers = wordList[Math.floor(Math.random() * wordList.length)];
                wordForImpostor = "IMPOSTOR";
                break;
            case 3:
            default:
                currentRoundType = "Todos con palabra distinta";
                impostorIndices = [];
                break;
        }
    } else {
        // 3. Lógica de Ronda Normal
        currentRoundType = "normal";
        
        const playerWordIndex = Math.floor(Math.random() * wordList.length);
        wordForPlayers = wordList[playerWordIndex];

        if (!impostorKnows) {
            let impostorWordIndex = Math.floor(Math.random() * wordList.length);
            while (impostorWordIndex === playerWordIndex) {
                impostorWordIndex = Math.floor(Math.random() * wordList.length);
            }
            wordForImpostor = wordList[impostorWordIndex];
        } else {
            wordForImpostor = "IMPOSTOR";
        }

        const availablePlayerIndices = Array.from({length: playerCount}, (_, i) => i);
        let count = impostorCount; // Usar la variable global
        while (count > 0 && availablePlayerIndices.length > 0) {
            const impostorIndex = availablePlayerIndices.splice(Math.floor(Math.random() * availablePlayerIndices.length), 1)[0];
            impostorIndices.push(impostorIndex);
            count--;
        }
    }
}

// --- FUNCIONES DE UI (LOCAL) ---
function renderPlayerNameInputs() {
    playerNamesContainer.innerHTML = '';
    // Asegura que playerNames tenga el tamaño correcto
    while (playerNames.length < playerCount) {
        playerNames.push(`Jugador ${playerNames.length + 1}`);
    }
    playerNames = playerNames.slice(0, playerCount);

    for (let i = 0; i < playerCount; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.classList.add('input-field'); // Reusar estilo
        input.placeholder = `Jugador ${i + 1}`;
        input.value = playerNames[i];
        input.dataset.index = i;
        input.addEventListener('input', (e) => {
            playerNames[i] = e.target.value.trim() || `Jugador ${i + 1}`;
        });
        playerNamesContainer.appendChild(input);
    }
    playerCountEl.textContent = playerCount;
    updateImpostorLimits();
}

function updateImpostorLimits() {
    if (impostorCount >= playerCount) {
        impostorCount = playerCount - 1;
    }
    if (playerCount > 1 && impostorCount < 1) {
        impostorCount = 1;
    }
    impostorCountEl.textContent = impostorCount;
}

function updateWordScreenUI() {
    playerNameDisplayEl.textContent = playerNames[currentPlayerIndex];
    wordDisplayEl.textContent = "";
    wordDisplayEl.classList.add('hidden');
    showWordBtn.classList.remove('hidden');

    if (currentPlayerIndex === playerCount - 1) {
        nextPlayerBtn.textContent = "Finalizar Ronda";
    } else {
        nextPlayerBtn.textContent = "Siguiente Jugador";
    }
}

// --- EVENT LISTENERS (Menús Iniciales) ---
startGameBtn.addEventListener('click', () => {
    showScreen(configScreen);
    renderPlayerNameInputs();
});

// NUEVO: Comprobación de estado de Firebase antes de ir al menú online
onlineGameBtn.addEventListener('click', () => {
    if (!isFirebaseReady) {
        showMessage("Aún estamos estableciendo la conexión con el servidor. Por favor, espera un momento y vuelve a intentarlo.");
        return;
    }
    showScreen(onlineMenuScreen);
});

backToStartBtn.addEventListener('click', () => showScreen(startScreen));
backToStartBtnLocal.addEventListener('click', () => showScreen(startScreen));


// --- EVENT LISTENERS (Online) ---
createRoomBtn.addEventListener('click', handleCreateRoom);
joinRoomMenuBtn.addEventListener('click', () => showScreen(joinRoomScreen));
backToOnlineMenuBtn.addEventListener('click', () => showScreen(onlineMenuScreen));
submitJoinBtn.addEventListener('click', handleJoinRoom);
lobbyLeaveBtn.addEventListener('click', leaveRoom);
lobbyStartGameBtn.addEventListener('click', handleOnlineStartGame);

// Listeners para controles del host en lobby
lobbyImpostorsMinus.addEventListener('click', () => {
    let count = parseInt(lobbyImpostorCountDisplay.textContent);
    if (count > 1) {
        lobbyImpostorCountDisplay.textContent = count - 1;
        updateLobbyConfig();
    }
});
lobbyImpostorsPlus.addEventListener('click', () => {
    let count = parseInt(lobbyImpostorCountDisplay.textContent);
    // Límite (ej. 10)
    if (count < 10) { 
        lobbyImpostorCountDisplay.textContent = count + 1;
        updateLobbyConfig();
    }
});
lobbyCategorySelector.addEventListener('change', updateLobbyConfig);
lobbySpecialRoundsCheck.addEventListener('change', updateLobbyConfig);
lobbyImpostorKnowsCheck.addEventListener('change', updateLobbyConfig);


// --- EVENT LISTENERS (Config Local) ---
toggleNamesBtn.addEventListener('click', () => {
    playerNamesContainer.classList.toggle('hidden');
    const isHidden = playerNamesContainer.classList.contains('hidden');
    toggleNamesBtn.textContent = isHidden ? "Cambiar nombres de jugadores" : "Ocultar nombres";
});
playersMinusBtn.addEventListener('click', () => {
    if (playerCount > 3) {
        playerCount--;
        renderPlayerNameInputs();
    } else {
        showMessage("La cantidad mínima de jugadores es 3.");
    }
});
playersPlusBtn.addEventListener('click', () => {
    if (playerCount < 34) {
        playerCount++;
        renderPlayerNameInputs();
    } else {
        showMessage("Límite de 34 jugadores alcanzado.");
    }
});
impostorsMinusBtn.addEventListener('click', () => {
    if (impostorCount > 1) {
        impostorCount--;
        impostorCountEl.textContent = impostorCount;
    } else {
        showMessage("La cantidad mínima de impostores es 1.");
    }
    updateImpostorLimits();
});
impostorsPlusBtn.addEventListener('click', () => {
    if (impostorCount < playerCount - 1) {
        impostorCount++;
        impostorCountEl.textContent = impostorCount;
    } else {
        showMessage(`No puede haber ${playerCount} o más impostores si solo hay ${playerCount} jugadores.`);
    }
    updateImpostorLimits();
});

// Botón Iniciar Partida (Local)
startRoundBtn.addEventListener('click', () => {
    // Leer config local
    impostorCount = parseInt(impostorCountEl.textContent);
    selectedCategory = categorySelector.value;
    enableSpecialRounds = specialRoundsCheck.checked;
    impostorKnows = impostorKnowsCheck.checked;
    
    // Validaciones locales
    if (playerCount <= impostorCount) {
        showMessage("La cantidad de jugadores debe ser mayor que la de impostores.");
        return;
    }
    document.querySelectorAll('#player-names-container .input-field').forEach((input, index) => {
        playerNames[index] = input.value.trim() || `Jugador ${index + 1}`;
    });

    setupGame(); // Prepara el juego local
    updateWordScreenUI();
    showScreen(wordScreen);
});


// --- EVENT LISTENERS (Juego) ---
showWordBtn.addEventListener('click', () => {
    const isImpostor = impostorIndices.includes(currentPlayerIndex);
    
    wordDisplayEl.classList.remove('impostor-text');
    stopAlarm();

    if (currentRoundType === "Todos con palabra distinta") {
        let wordList;
        if (selectedCategory === 'random') {
            const allLists = Object.values(allWordLists);
            wordList = allLists[Math.floor(Math.random() * allLists.length)];
        } else {
            wordList = allWordLists[selectedCategory];
        }
        wordDisplayEl.textContent = wordList[Math.floor(Math.random() * wordList.length)];
    
    } else if (isImpostor) {
        wordDisplayEl.textContent = wordForImpostor;
        wordDisplayEl.classList.add('impostor-text');
        
        if (enableSpecialRounds) {
            document.body.classList.add('impostor-alarm');
            alarmSound.play().catch(e => console.warn("La reproducción de audio fue bloqueada."));
        }
        
    } else {
        wordDisplayEl.textContent = wordForPlayers;
    }

    wordDisplayEl.classList.remove('hidden');
    showWordBtn.classList.add('hidden');
});

// Botón Siguiente Jugador
nextPlayerBtn.addEventListener('click', () => {
    stopAlarm();
    
    if (currentPlayerIndex < playerCount - 1) {
        currentPlayerIndex++;
        updateWordScreenUI();
    } else {
        // Modificar botones de pantalla final según el modo (local/online)
        if (currentRoomId) {
            // Modo Online
            playAgainBtn.textContent = "Jugar de Nuevo";
            changeSettingsBtn.textContent = "Volver al Lobby";
            playAgainBtn.style.display = isHost ? 'flex' : 'none'; // Solo host puede reiniciar
        } else {
            // Modo Local
            playAgainBtn.textContent = "Jugar de Nuevo";
            changeSettingsBtn.textContent = "Cambiar Ajustes";
            playAgainBtn.style.display = 'flex';
        }
        
        endMessageInitialEl.classList.remove('hidden');
        impostorRevealBtn.classList.remove('hidden');
        revealArea.classList.add('hidden');
        specialRoundInfoEl.classList.add('hidden');
        showScreen(endScreen);
    }
});

// --- EVENT LISTENERS (Pantalla Final) ---
impostorRevealBtn.addEventListener('click', () => {
    stopAlarm();
    impostorRevealBtn.classList.add('hidden');
    endMessageInitialEl.classList.add('hidden');
    revealArea.classList.remove('hidden');
    impostorListEl.innerHTML = '';

    if (currentRoundType !== "normal") {
        let specialText = `¡Ronda Especial: ${currentRoundType}!`;
        if (currentRoundType === "Nadie es Impostor") {
            specialText += " Todos tenían la palabra.";
        } else if (currentRoundType === "Todos con palabra distinta") {
            specialText += " Cada uno vio algo diferente.";
        }
        specialRoundInfoEl.textContent = specialText;
        specialRoundInfoEl.classList.remove('hidden');
    } else {
        specialRoundInfoEl.classList.add('hidden');
    }

    if (impostorIndices.length > 0) {
        endMessageFinal.textContent = "Los impostores eran:";
        impostorIndices.forEach(index => {
            if (playerNames[index]) {
                const li = document.createElement('li');
                li.textContent = playerNames[index];
                impostorListEl.appendChild(li);
            }
        });
    } else {
        endMessageFinal.textContent = "¡No había impostores esta ronda!";
    }
});

// Botón Jugar de Nuevo (Ahora maneja local y online)
playAgainBtn.addEventListener('click', () => {
    stopAlarm();
    if (currentRoomId && isHost) {
        // Online: Host inicia otra ronda
        handleOnlineStartGame();
    } else if (!currentRoomId) {
        // Local: Inicia otra ronda
        setupGame();
        updateWordScreenUI();
        showScreen(wordScreen);
    }
});

// Botón Cambiar Ajustes (Ahora maneja local y online)
changeSettingsBtn.addEventListener('click', () => {
    stopAlarm();
    if (currentRoomId && isHost) {
        // Online: Host vuelve al lobby
        handleBackToLobby();
    } else if (currentRoomId && !isHost) {
        // Online: Invitado sale de la sala
        leaveRoom();
    } else if (!currentRoomId) {
        // Local: Vuelve a config local
        renderPlayerNameInputs();
        showScreen(configScreen);
    }
});


// --- INICIALIZACIÓN ---
document.addEventListener('DOMContentLoaded', async () => {
    // El botón online se deshabilita en el HTML/CSS y se habilita aquí
    // El texto también se actualiza al finalizar la conexión
    
    try {
        await initFirebase(); // Esperar a que Firebase esté listo (con reintentos y timeout)
    } catch (e) {
        // initFirebase ya actualiza la UI si falla, este catch es solo un respaldo.
        console.error("Fallo la inicialización de Firebase", e);
    }
    
    // Cargar estado inicial de checkboxes locales
    enableSpecialRounds = specialRoundsCheck.checked;
    impostorKnows = impostorKnowsCheck.checked;

    showScreen(startScreen);
    renderPlayerNameInputs(); // Inicializa los inputs de nombre local
});

</script>
</body>
</html>